
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>qappimageupdate_p.cc</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> * BSD 3-Clause License</a>
<a name="ln3"> *</a>
<a name="ln4"> * Copyright (c) 2018-2019, Antony jr</a>
<a name="ln5"> * All rights reserved.</a>
<a name="ln6"> *</a>
<a name="ln7"> * Redistribution and use in source and binary forms, with or without</a>
<a name="ln8"> * modification, are permitted provided that the following conditions are met:</a>
<a name="ln9"> *</a>
<a name="ln10"> * * Redistributions of source code must retain the above copyright notice, this</a>
<a name="ln11"> *   list of conditions and the following disclaimer.</a>
<a name="ln12"> *</a>
<a name="ln13"> * * Redistributions in binary form must reproduce the above copyright notice,</a>
<a name="ln14"> *   this list of conditions and the following disclaimer in the documentation</a>
<a name="ln15"> *   and/or other materials provided with the distribution.</a>
<a name="ln16"> *</a>
<a name="ln17"> * * Neither the name of the copyright holder nor the names of its</a>
<a name="ln18"> *   contributors may be used to endorse or promote products derived from</a>
<a name="ln19"> *   this software without specific prior written permission.</a>
<a name="ln20"> *</a>
<a name="ln21"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</a>
<a name="ln22"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</a>
<a name="ln23"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</a>
<a name="ln24"> * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE</a>
<a name="ln25"> * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</a>
<a name="ln26"> * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</a>
<a name="ln27"> * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</a>
<a name="ln28"> * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</a>
<a name="ln29"> * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</a>
<a name="ln30"> * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</a>
<a name="ln31"> *</a>
<a name="ln32">*/</a>
<a name="ln33"> </a>
<a name="ln34">#include &lt;QCoreApplication&gt;</a>
<a name="ln35"> </a>
<a name="ln36">#include &quot;qappimageupdate_p.hpp&quot;</a>
<a name="ln37">#include &quot;helpers_p.hpp&quot;</a>
<a name="ln38"> </a>
<a name="ln39">#ifndef NO_GUI</a>
<a name="ln40">#include &lt;QApplication&gt;</a>
<a name="ln41">#include &lt;QMessageBox&gt;</a>
<a name="ln42">#include &lt;QProcess&gt;</a>
<a name="ln43">#include &lt;QScreen&gt;</a>
<a name="ln44">#include &lt;QPixmap&gt;</a>
<a name="ln45"> </a>
<a name="ln46">#include &quot;softwareupdatedialog_p.hpp&quot;</a>
<a name="ln47">#include &lt;ui_AppImageUpdaterDialog.h&gt;</a>
<a name="ln48">#endif // NOT NO_GUI</a>
<a name="ln49"> </a>
<a name="ln50"> </a>
<a name="ln51">QAppImageUpdatePrivate::QAppImageUpdatePrivate(bool singleThreaded, QObject *parent)</a>
<a name="ln52">    : QObject(parent) {</a>
<a name="ln53">    setObjectName(&quot;QAppImageUpdatePrivate&quot;);</a>
<a name="ln54">    if(!singleThreaded) {</a>
<a name="ln55">        m_SharedThread.reset(new QThread);</a>
<a name="ln56">        m_SharedThread-&gt;start();</a>
<a name="ln57">    }</a>
<a name="ln58"> </a>
<a name="ln59"> </a>
<a name="ln60">    m_SharedNetworkAccessManager.reset(new QNetworkAccessManager);</a>
<a name="ln61">    m_UpdateInformation.reset(new AppImageUpdateInformationPrivate);</a>
<a name="ln62">    m_DeltaWriter.reset(new ZsyncWriterPrivate(m_SharedNetworkAccessManager.data()));</a>
<a name="ln63">#ifdef DECENTRALIZED_UPDATE_ENABLED</a>
<a name="ln64">    m_Seeder.reset(new Seeder(m_SharedNetworkAccessManager.data()));</a>
<a name="ln65">#endif</a>
<a name="ln66"> </a>
<a name="ln67">    if(!singleThreaded) {</a>
<a name="ln68">        m_SharedNetworkAccessManager-&gt;moveToThread(m_SharedThread.data());</a>
<a name="ln69">        m_UpdateInformation-&gt;moveToThread(m_SharedThread.data());</a>
<a name="ln70">        m_DeltaWriter-&gt;moveToThread(m_SharedThread.data());</a>
<a name="ln71">#ifdef DECENTRALIZED_UPDATE_ENABLED</a>
<a name="ln72">	m_Seeder-&gt;moveToThread(m_SharedThread.data());</a>
<a name="ln73">#endif       </a>
<a name="ln74">    }</a>
<a name="ln75">    m_ControlFileParser.reset(new ZsyncRemoteControlFileParserPrivate(m_SharedNetworkAccessManager.data()));</a>
<a name="ln76">    if(!singleThreaded) {</a>
<a name="ln77">        m_ControlFileParser-&gt;moveToThread(m_SharedThread.data());</a>
<a name="ln78">    }</a>
<a name="ln79">    m_ControlFileParser-&gt;setObjectName(&quot;ZsyncRemoteControlFileParserPrivate&quot;);</a>
<a name="ln80">    m_UpdateInformation-&gt;setObjectName(&quot;AppImageUpdateInformationPrivate&quot;);</a>
<a name="ln81">    m_DeltaWriter-&gt;setObjectName(&quot;ZsyncWriterPrivate&quot;);</a>
<a name="ln82"> </a>
<a name="ln83">    // Set logger name</a>
<a name="ln84">    m_UpdateInformation-&gt;setLoggerName(&quot;UpdateInformation&quot;);</a>
<a name="ln85">    m_ControlFileParser-&gt;setLoggerName(&quot;ControlFileParser&quot;);</a>
<a name="ln86">    m_DeltaWriter-&gt;setLoggerName(&quot;DeltaWriter&quot;);</a>
<a name="ln87"> </a>
<a name="ln88"> </a>
<a name="ln89">    // Update information</a>
<a name="ln90">    connect(m_UpdateInformation.data(), &amp;AppImageUpdateInformationPrivate::logger,</a>
<a name="ln91">            this, &amp;QAppImageUpdatePrivate::logger,</a>
<a name="ln92">            (Qt::ConnectionType)(Qt::DirectConnection | Qt::UniqueConnection));</a>
<a name="ln93">    connect(m_UpdateInformation.data(), SIGNAL(operatingAppImagePath(QString)),</a>
<a name="ln94">            this, SLOT(setCurrentAppImagePath(QString)),</a>
<a name="ln95">            Qt::QueuedConnection);</a>
<a name="ln96"> </a>
<a name="ln97"> </a>
<a name="ln98">    // Control file parsing</a>
<a name="ln99">    connect(m_ControlFileParser.data(), &amp;ZsyncRemoteControlFileParserPrivate::logger,</a>
<a name="ln100">            this, &amp;QAppImageUpdatePrivate::logger,</a>
<a name="ln101">            (Qt::ConnectionType)(Qt::DirectConnection | Qt::UniqueConnection));</a>
<a name="ln102"> </a>
<a name="ln103">    // Delta Writer and Downloader</a>
<a name="ln104">    connect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::logger,</a>
<a name="ln105">            this, &amp;QAppImageUpdatePrivate::logger,</a>
<a name="ln106">            (Qt::ConnectionType)(Qt::DirectConnection | Qt::UniqueConnection));</a>
<a name="ln107">    connect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::started,</a>
<a name="ln108">            this, &amp;QAppImageUpdatePrivate::handleUpdateStart,</a>
<a name="ln109">   	    (Qt::ConnectionType)(Qt::QueuedConnection | Qt::UniqueConnection));</a>
<a name="ln110"> </a>
<a name="ln111">    // Torrent Seeder</a>
<a name="ln112">#ifdef DECENTRALIZED_UPDATE_ENABLED </a>
<a name="ln113">    connect(m_Seeder.data(), &amp;Seeder::started,</a>
<a name="ln114">            this, &amp;QAppImageUpdatePrivate::torrentClientStarted ,</a>
<a name="ln115">            (Qt::ConnectionType)(Qt::DirectConnection | Qt::UniqueConnection));</a>
<a name="ln116">    connect(m_Seeder.data(), &amp;Seeder::torrentStatus,</a>
<a name="ln117">            this, &amp;QAppImageUpdatePrivate::torrentStatus,</a>
<a name="ln118">            (Qt::ConnectionType)(Qt::DirectConnection | Qt::UniqueConnection));</a>
<a name="ln119">#endif</a>
<a name="ln120"> </a>
<a name="ln121">    // Torrent Downloader Specific</a>
<a name="ln122">    connect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::torrentClientStarted,</a>
<a name="ln123">            this, &amp;QAppImageUpdatePrivate::torrentClientStarted ,</a>
<a name="ln124">            (Qt::ConnectionType)(Qt::DirectConnection | Qt::UniqueConnection));</a>
<a name="ln125">    connect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::torrentStatus,</a>
<a name="ln126">            this, &amp;QAppImageUpdatePrivate::torrentStatus,</a>
<a name="ln127">            (Qt::ConnectionType)(Qt::DirectConnection | Qt::UniqueConnection));</a>
<a name="ln128">}</a>
<a name="ln129"> </a>
<a name="ln130">QAppImageUpdatePrivate::QAppImageUpdatePrivate(const QString &amp;AppImagePath, bool singleThreaded, QObject *parent)</a>
<a name="ln131">    : QAppImageUpdatePrivate(singleThreaded, parent) {</a>
<a name="ln132">    setAppImage(AppImagePath);</a>
<a name="ln133">    return;</a>
<a name="ln134">}</a>
<a name="ln135"> </a>
<a name="ln136">QAppImageUpdatePrivate::QAppImageUpdatePrivate(QFile *AppImage, bool singleThreaded, QObject *parent)</a>
<a name="ln137">    : QAppImageUpdatePrivate(singleThreaded, parent) {</a>
<a name="ln138">    setAppImage(AppImage);</a>
<a name="ln139">    return;</a>
<a name="ln140">}</a>
<a name="ln141"> </a>
<a name="ln142">QAppImageUpdatePrivate::~QAppImageUpdatePrivate() {</a>
<a name="ln143">    if(b_Started || b_Running) {</a>
<a name="ln144">        cancel();</a>
<a name="ln145">    }</a>
<a name="ln146"> </a>
<a name="ln147">    if(!m_SharedThread.isNull()) {</a>
<a name="ln148">        m_SharedThread-&gt;quit();</a>
<a name="ln149">        m_SharedThread-&gt;wait();</a>
<a name="ln150">    }</a>
<a name="ln151">    return;</a>
<a name="ln152">}</a>
<a name="ln153"> </a>
<a name="ln154">void QAppImageUpdatePrivate::setApplicationName(const QString &amp;applicationName) {</a>
<a name="ln155">    if(b_Started || b_Running) {</a>
<a name="ln156">        return;</a>
<a name="ln157">    }</a>
<a name="ln158">    m_ApplicationName = applicationName;</a>
<a name="ln159">}</a>
<a name="ln160"> </a>
<a name="ln161">void QAppImageUpdatePrivate::setIcon(QByteArray icon) {</a>
<a name="ln162">    if(b_Started || b_Running) {</a>
<a name="ln163">        return;</a>
<a name="ln164">    }</a>
<a name="ln165"> </a>
<a name="ln166">    m_Icon = icon;</a>
<a name="ln167">}</a>
<a name="ln168"> </a>
<a name="ln169">void QAppImageUpdatePrivate::setGuiFlag(int flag) {</a>
<a name="ln170">    if(b_Started || b_Running) {</a>
<a name="ln171">        return;</a>
<a name="ln172">    }</a>
<a name="ln173"> </a>
<a name="ln174">    n_GuiFlag = flag;</a>
<a name="ln175">}</a>
<a name="ln176"> </a>
<a name="ln177">void QAppImageUpdatePrivate::setAppImage(const QString &amp;AppImagePath) {</a>
<a name="ln178">    if(b_Started || b_Running) {</a>
<a name="ln179">        return;</a>
<a name="ln180">    }</a>
<a name="ln181"> </a>
<a name="ln182">    clear();</a>
<a name="ln183">    getMethod(m_UpdateInformation.data(), &quot;setAppImage(const QString&amp;)&quot;)</a>
<a name="ln184">    .invoke(m_UpdateInformation.data(),</a>
<a name="ln185">            Qt::QueuedConnection,</a>
<a name="ln186">            Q_ARG(QString,AppImagePath));</a>
<a name="ln187">    return;</a>
<a name="ln188">}</a>
<a name="ln189"> </a>
<a name="ln190">void QAppImageUpdatePrivate::setAppImage(QFile *AppImage) {</a>
<a name="ln191">    if(b_Started || b_Running) {</a>
<a name="ln192">        return;</a>
<a name="ln193">    }</a>
<a name="ln194"> </a>
<a name="ln195">    clear();</a>
<a name="ln196">    getMethod(m_UpdateInformation.data(), &quot;setAppImage(QFile *)&quot;)</a>
<a name="ln197">    .invoke(m_UpdateInformation.data(),</a>
<a name="ln198">            Qt::QueuedConnection,</a>
<a name="ln199">            Q_ARG(QFile*,AppImage));</a>
<a name="ln200">}</a>
<a name="ln201"> </a>
<a name="ln202">void QAppImageUpdatePrivate::setShowLog(bool choice) {</a>
<a name="ln203">    if(b_Started || b_Running) {</a>
<a name="ln204">        return;</a>
<a name="ln205">    }</a>
<a name="ln206"> </a>
<a name="ln207">    getMethod(m_UpdateInformation.data(), &quot;setShowLog(bool)&quot;)</a>
<a name="ln208">    .invoke(m_UpdateInformation.data(),</a>
<a name="ln209">            Qt::QueuedConnection,</a>
<a name="ln210">            Q_ARG(bool, choice));</a>
<a name="ln211"> </a>
<a name="ln212">    getMethod(m_ControlFileParser.data(), &quot;setShowLog(bool)&quot;)</a>
<a name="ln213">    .invoke(m_ControlFileParser.data(),</a>
<a name="ln214">            Qt::QueuedConnection,</a>
<a name="ln215">            Q_ARG(bool, choice));</a>
<a name="ln216"> </a>
<a name="ln217">    getMethod(m_DeltaWriter.data(), &quot;setShowLog(bool)&quot;)</a>
<a name="ln218">    .invoke(m_DeltaWriter.data(),</a>
<a name="ln219">            Qt::QueuedConnection,</a>
<a name="ln220">            Q_ARG(bool, choice));</a>
<a name="ln221">}</a>
<a name="ln222"> </a>
<a name="ln223">void QAppImageUpdatePrivate::setOutputDirectory(const QString &amp;dir) {</a>
<a name="ln224">    if(b_Started || b_Running) {</a>
<a name="ln225">        return;</a>
<a name="ln226">    }</a>
<a name="ln227"> </a>
<a name="ln228">    getMethod(m_DeltaWriter.data(), &quot;setOutputDirectory(const QString&amp;)&quot;)</a>
<a name="ln229">    .invoke(m_DeltaWriter.data(),</a>
<a name="ln230">            Qt::QueuedConnection,</a>
<a name="ln231">            Q_ARG(QString, dir));</a>
<a name="ln232">    return;</a>
<a name="ln233">}</a>
<a name="ln234"> </a>
<a name="ln235">void QAppImageUpdatePrivate::setProxy(const QNetworkProxy &amp;proxy) {</a>
<a name="ln236">    if(b_Started || b_Running) {</a>
<a name="ln237">        return;</a>
<a name="ln238">    }</a>
<a name="ln239">    m_SharedNetworkAccessManager-&gt;setProxy(proxy);</a>
<a name="ln240">    return;</a>
<a name="ln241">}</a>
<a name="ln242"> </a>
<a name="ln243">void QAppImageUpdatePrivate::clear(void) {</a>
<a name="ln244">    if(b_Started || b_Running) {</a>
<a name="ln245">        return;</a>
<a name="ln246">    }</a>
<a name="ln247"> </a>
<a name="ln248">    b_Started = b_Running = b_Finished = b_Canceled = b_CancelRequested = false;</a>
<a name="ln249">    getMethod(m_UpdateInformation.data(), &quot;clear(void)&quot;)</a>
<a name="ln250">    .invoke(m_UpdateInformation.data(), Qt::QueuedConnection);</a>
<a name="ln251">    getMethod(m_ControlFileParser.data(), &quot;clear(void)&quot;)</a>
<a name="ln252">    .invoke(m_ControlFileParser.data(), Qt::QueuedConnection);</a>
<a name="ln253">    return;</a>
<a name="ln254">}</a>
<a name="ln255"> </a>
<a name="ln256"> </a>
<a name="ln257">void QAppImageUpdatePrivate::start(short action, int flags, QByteArray icon) {</a>
<a name="ln258">    if(b_Started || b_Running) {</a>
<a name="ln259">        return;</a>
<a name="ln260">    }</a>
<a name="ln261"> </a>
<a name="ln262">    b_Started = b_Running = true;</a>
<a name="ln263">    b_Canceled = false;</a>
<a name="ln264">    b_Finished = false;</a>
<a name="ln265"> </a>
<a name="ln266">    if(b_CancelRequested) {</a>
<a name="ln267">        b_Started = b_Running = false;</a>
<a name="ln268">        b_Canceled = true;</a>
<a name="ln269">        b_CancelRequested = false;</a>
<a name="ln270">        emit canceled(action);</a>
<a name="ln271">        return;</a>
<a name="ln272">    }</a>
<a name="ln273"> </a>
<a name="ln274">    if(flags != (int)GuiFlag::None) {</a>
<a name="ln275">	    n_GuiFlag = flags;</a>
<a name="ln276">    }else if(n_GuiFlag == GuiFlag::None) {</a>
<a name="ln277">	    n_GuiFlag = GuiFlag::Default;</a>
<a name="ln278">    }</a>
<a name="ln279"> </a>
<a name="ln280">    if(icon.isEmpty() &amp;&amp; !m_Icon.isEmpty()) {</a>
<a name="ln281">        icon = m_Icon;</a>
<a name="ln282">    }</a>
<a name="ln283"> </a>
<a name="ln284">    if(action == Action::GetEmbeddedInfo) {</a>
<a name="ln285">        n_CurrentAction = action;</a>
<a name="ln286">        connect(m_UpdateInformation.data(),  &amp;AppImageUpdateInformationPrivate::info,</a>
<a name="ln287">                this, &amp;QAppImageUpdatePrivate::redirectEmbeddedInformation,</a>
<a name="ln288">                Qt::QueuedConnection);</a>
<a name="ln289">        connect(m_UpdateInformation.data(), &amp;AppImageUpdateInformationPrivate::progress,</a>
<a name="ln290">                this, &amp;QAppImageUpdatePrivate::handleGetEmbeddedInfoProgress);</a>
<a name="ln291">        connect(m_UpdateInformation.data(),  &amp;AppImageUpdateInformationPrivate::error,</a>
<a name="ln292">                this, &amp;QAppImageUpdatePrivate::handleGetEmbeddedInfoError,</a>
<a name="ln293">                Qt::QueuedConnection);</a>
<a name="ln294"> </a>
<a name="ln295">        emit started(Action::GetEmbeddedInfo);</a>
<a name="ln296">        getMethod(m_UpdateInformation.data(), &quot;getInfo(void)&quot;)</a>
<a name="ln297">        .invoke(m_UpdateInformation.data(), Qt::QueuedConnection);</a>
<a name="ln298"> </a>
<a name="ln299">    } else if(action == Action::CheckForUpdate) {</a>
<a name="ln300">        n_CurrentAction = action;</a>
<a name="ln301"> </a>
<a name="ln302">        //// Needed to check if Bittorrent file is</a>
<a name="ln303">        //// supported.</a>
<a name="ln304">#ifdef DECENTRALIZED_UPDATE_ENABLED</a>
<a name="ln305">        m_ControlFileParser-&gt;setUseBittorrent(true);</a>
<a name="ln306">#else</a>
<a name="ln307">        m_ControlFileParser-&gt;setUseBittorrent(false);</a>
<a name="ln308">#endif</a>
<a name="ln309">        connect(m_UpdateInformation.data(), SIGNAL(info(QJsonObject)),</a>
<a name="ln310">                m_ControlFileParser.data(), SLOT(setControlFileUrl(QJsonObject)),</a>
<a name="ln311">                (Qt::ConnectionType)(Qt::UniqueConnection | Qt::QueuedConnection));</a>
<a name="ln312"> </a>
<a name="ln313">        connect(m_ControlFileParser.data(), SIGNAL(receiveControlFile(void)),</a>
<a name="ln314">                m_ControlFileParser.data(), SLOT(getUpdateCheckInformation(void)),</a>
<a name="ln315">                (Qt::ConnectionType)(Qt::UniqueConnection | Qt::QueuedConnection));</a>
<a name="ln316"> </a>
<a name="ln317">        connect(m_ControlFileParser.data(), SIGNAL(updateCheckInformation(QJsonObject)),</a>
<a name="ln318">                this, SLOT(redirectUpdateCheck(QJsonObject)),</a>
<a name="ln319">                (Qt::ConnectionType)(Qt::UniqueConnection | Qt::QueuedConnection));</a>
<a name="ln320"> </a>
<a name="ln321">        connect(m_ControlFileParser.data(), SIGNAL(progress(int)),</a>
<a name="ln322">                this, SLOT(handleCheckForUpdateProgress(int)));</a>
<a name="ln323"> </a>
<a name="ln324">        connect(m_ControlFileParser.data(), SIGNAL(error(short)),</a>
<a name="ln325">                this, SLOT(handleCheckForUpdateError(short)),</a>
<a name="ln326">                (Qt::ConnectionType)(Qt::UniqueConnection | Qt::QueuedConnection));</a>
<a name="ln327"> </a>
<a name="ln328">        connect(m_UpdateInformation.data(), SIGNAL(error(short)),</a>
<a name="ln329">                this, SLOT(handleCheckForUpdateError(short)),</a>
<a name="ln330">                (Qt::ConnectionType)(Qt::UniqueConnection | Qt::QueuedConnection));</a>
<a name="ln331"> </a>
<a name="ln332"> </a>
<a name="ln333">        emit started(Action::CheckForUpdate);</a>
<a name="ln334">        getMethod(m_UpdateInformation.data(), &quot;getInfo(void)&quot;)</a>
<a name="ln335">        .invoke(m_UpdateInformation.data(), Qt::QueuedConnection);</a>
<a name="ln336">    } else if(action == Action::Update || action == Action::UpdateWithTorrent) {</a>
<a name="ln337">        n_CurrentAction = action;</a>
<a name="ln338"> </a>
<a name="ln339">        //// With respect to GDPR, It is strongly adviced</a>
<a name="ln340">        //// to use Torrent only if the user explicitly</a>
<a name="ln341">        //// asks for it.</a>
<a name="ln342">#ifdef DECENTRALIZED_UPDATE_ENABLED</a>
<a name="ln343">        m_ControlFileParser-&gt;setUseBittorrent((action == Action::UpdateWithTorrent));</a>
<a name="ln344">#else</a>
<a name="ln345">        m_ControlFileParser-&gt;setUseBittorrent(false);</a>
<a name="ln346">#endif</a>
<a name="ln347">        connect(m_UpdateInformation.data(), SIGNAL(info(QJsonObject)),</a>
<a name="ln348">                m_ControlFileParser.data(), SLOT(setControlFileUrl(QJsonObject)),</a>
<a name="ln349">                (Qt::ConnectionType)(Qt::UniqueConnection | Qt::QueuedConnection));</a>
<a name="ln350"> </a>
<a name="ln351">        connect(m_ControlFileParser.data(), SIGNAL(receiveControlFile(void)),</a>
<a name="ln352">                m_ControlFileParser.data(), SLOT(getZsyncInformation(void)),</a>
<a name="ln353">                (Qt::ConnectionType)(Qt::UniqueConnection | Qt::QueuedConnection));</a>
<a name="ln354"> </a>
<a name="ln355">        connect(m_ControlFileParser.data(), &amp;ZsyncRemoteControlFileParserPrivate::zsyncInformation,</a>
<a name="ln356">                m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::setConfiguration,</a>
<a name="ln357">                (Qt::ConnectionType)(Qt::QueuedConnection | Qt::UniqueConnection));</a>
<a name="ln358"> </a>
<a name="ln359">        connect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::finishedConfiguring,</a>
<a name="ln360">                m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::start,</a>
<a name="ln361">                (Qt::ConnectionType)(Qt::QueuedConnection | Qt::UniqueConnection));</a>
<a name="ln362"> </a>
<a name="ln363">        connect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::finished,</a>
<a name="ln364">                this, &amp;QAppImageUpdatePrivate::handleUpdateFinished,</a>
<a name="ln365">                (Qt::ConnectionType)(Qt::QueuedConnection | Qt::UniqueConnection));</a>
<a name="ln366"> </a>
<a name="ln367">        connect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::error,</a>
<a name="ln368">                this, &amp;QAppImageUpdatePrivate::handleUpdateError,</a>
<a name="ln369">                (Qt::ConnectionType)(Qt::QueuedConnection | Qt::UniqueConnection));</a>
<a name="ln370"> </a>
<a name="ln371">        connect(m_UpdateInformation.data(), &amp;AppImageUpdateInformationPrivate::error,</a>
<a name="ln372">                this, &amp;QAppImageUpdatePrivate::handleUpdateError,</a>
<a name="ln373">                (Qt::ConnectionType)(Qt::QueuedConnection | Qt::UniqueConnection));</a>
<a name="ln374"> </a>
<a name="ln375">        connect(m_ControlFileParser.data(), &amp;ZsyncRemoteControlFileParserPrivate::error,</a>
<a name="ln376">                this, &amp;QAppImageUpdatePrivate::handleUpdateError,</a>
<a name="ln377">                (Qt::ConnectionType)(Qt::QueuedConnection | Qt::UniqueConnection));</a>
<a name="ln378"> </a>
<a name="ln379">        connect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::progress,</a>
<a name="ln380">                this, &amp;QAppImageUpdatePrivate::handleUpdateProgress,</a>
<a name="ln381">                (Qt::ConnectionType)(Qt::QueuedConnection | Qt::UniqueConnection));</a>
<a name="ln382"> </a>
<a name="ln383">        connect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::canceled,</a>
<a name="ln384">                this, &amp;QAppImageUpdatePrivate::handleUpdateCancel,</a>
<a name="ln385">                (Qt::ConnectionType)(Qt::QueuedConnection | Qt::UniqueConnection));</a>
<a name="ln386"> </a>
<a name="ln387">        //// Started signal will be emitted by handleUpdateStart</a>
<a name="ln388">        //// which is connected at the construction.</a>
<a name="ln389">        getMethod(m_UpdateInformation.data(), &quot;getInfo(void)&quot;)</a>
<a name="ln390">        .invoke(m_UpdateInformation.data(), Qt::QueuedConnection);</a>
<a name="ln391"> </a>
<a name="ln392">    } else if(action == Action::UpdateWithGUI || action == Action::UpdateWithGUIAndTorrent) {</a>
<a name="ln393">#ifdef NO_GUI</a>
<a name="ln394">        b_Started = b_CancelRequested = b_Finished = b_Canceled = false;</a>
<a name="ln395">        emit error(QAppImageUpdateEnums::Error::UnsupportedActionForBuild, action);</a>
<a name="ln396">        return;</a>
<a name="ln397">#else</a>
<a name="ln398">        n_CurrentAction = action;</a>
<a name="ln399"> </a>
<a name="ln400">        if(m_ApplicationName.isEmpty()) {</a>
<a name="ln401">            m_ApplicationName = QCoreApplication::applicationName();</a>
<a name="ln402">        }</a>
<a name="ln403"> </a>
<a name="ln404">        // Setup GUI if not constructed before</a>
<a name="ln405">        if(!b_GuiClassesConstructed) {</a>
<a name="ln406">            m_UpdaterDialog.reset(new QDialog);</a>
<a name="ln407">            m_UpdaterDialog-&gt;setObjectName(QString::fromUtf8(&quot;AppImageUpdaterDialog&quot;));</a>
<a name="ln408"> </a>
<a name="ln409">            m_Ui = QSharedPointer&lt;Ui::AppImageUpdaterDialog&gt;(new Ui::AppImageUpdaterDialog);</a>
<a name="ln410">            m_Ui-&gt;setupUi(m_UpdaterDialog.data());</a>
<a name="ln411"> </a>
<a name="ln412">            /*</a>
<a name="ln413">             * Default program logic.</a>
<a name="ln414">             */</a>
<a name="ln415"> </a>
<a name="ln416">            connect((m_Ui-&gt;updateCancelBtn), &amp;QPushButton::clicked, this, &amp;QAppImageUpdatePrivate::cancel, Qt::QueuedConnection);</a>
<a name="ln417">            connect(m_UpdaterDialog.data(), &amp;QDialog::rejected, this, &amp;QAppImageUpdatePrivate::cancel, Qt::QueuedConnection);</a>
<a name="ln418"> </a>
<a name="ln419">            b_GuiClassesConstructed = true;</a>
<a name="ln420">        }</a>
<a name="ln421"> </a>
<a name="ln422">        QPixmap icon;</a>
<a name="ln423"> </a>
<a name="ln424">        if(!m_Icon.isEmpty()) {</a>
<a name="ln425">            icon.loadFromData(m_Icon);</a>
<a name="ln426">        }</a>
<a name="ln427"> </a>
<a name="ln428">        /* Set AppImage icon if given. */</a>
<a name="ln429">        if(!icon.isNull()) {</a>
<a name="ln430">            (m_Ui-&gt;softwareIcon)-&gt;setPixmap(icon);</a>
<a name="ln431">            (m_Ui-&gt;softwareIconOnUpdating)-&gt;setPixmap(icon);</a>
<a name="ln432">            m_UpdaterDialog-&gt;setWindowIcon(icon);</a>
<a name="ln433">        } else {</a>
<a name="ln434">            bool found = false;</a>
<a name="ln435">            if(QApplication::windowIcon().isNull()) {</a>
<a name="ln436">                foreach (QWidget *widget, QApplication::allWidgets()) {</a>
<a name="ln437">                    if(!((widget-&gt;windowIcon()).isNull())) {</a>
<a name="ln438">                        icon = widget-&gt;windowIcon().pixmap(100, 100);</a>
<a name="ln439">                        (m_Ui-&gt;softwareIcon)-&gt;setPixmap(icon);</a>
<a name="ln440">                        (m_Ui-&gt;softwareIconOnUpdating)-&gt;setPixmap(icon);</a>
<a name="ln441">                        m_UpdaterDialog-&gt;setWindowIcon(icon);</a>
<a name="ln442">                        found = true;</a>
<a name="ln443">                        break;</a>
<a name="ln444">                    }</a>
<a name="ln445">                    QCoreApplication::processEvents();</a>
<a name="ln446">                }</a>
<a name="ln447">            } else {</a>
<a name="ln448">                icon = QApplication::windowIcon().pixmap(100, 100);</a>
<a name="ln449">                found = true;</a>
<a name="ln450">            }</a>
<a name="ln451"> </a>
<a name="ln452">            if(!found) {</a>
<a name="ln453">                (m_Ui-&gt;softwareIcon)-&gt;setVisible(false);</a>
<a name="ln454">                (m_Ui-&gt;softwareIconOnUpdating)-&gt;setVisible(false);</a>
<a name="ln455">            }</a>
<a name="ln456">        }</a>
<a name="ln457"> </a>
<a name="ln458">	// Reset Check For Update Progress Bar.</a>
<a name="ln459">	(m_Ui-&gt;updateCheckProgressBar)-&gt;setValue(0);    </a>
<a name="ln460"> </a>
<a name="ln461"> </a>
<a name="ln462">        m_ConfirmationDialog = QSharedPointer&lt;SoftwareUpdateDialog&gt;(new SoftwareUpdateDialog(nullptr, icon, n_GuiFlag));</a>
<a name="ln463"> </a>
<a name="ln464">#ifdef DECENTRALIZED_UPDATE_ENABLED</a>
<a name="ln465">        m_ControlFileParser-&gt;setUseBittorrent((action == Action::UpdateWithGUIAndTorrent));</a>
<a name="ln466">#else</a>
<a name="ln467">        m_ControlFileParser-&gt;setUseBittorrent(false);</a>
<a name="ln468">#endif</a>
<a name="ln469"> </a>
<a name="ln470">        connect(m_UpdateInformation.data(), SIGNAL(info(QJsonObject)),</a>
<a name="ln471">                m_ControlFileParser.data(), SLOT(setControlFileUrl(QJsonObject)),</a>
<a name="ln472">                (Qt::ConnectionType)(Qt::UniqueConnection | Qt::QueuedConnection));</a>
<a name="ln473"> </a>
<a name="ln474">        connect(m_ControlFileParser.data(), SIGNAL(receiveControlFile(void)),</a>
<a name="ln475">                m_ControlFileParser.data(), SLOT(getUpdateCheckInformation(void)),</a>
<a name="ln476">                (Qt::ConnectionType)(Qt::UniqueConnection | Qt::QueuedConnection));</a>
<a name="ln477"> </a>
<a name="ln478">        connect(m_ControlFileParser.data(), SIGNAL(updateCheckInformation(QJsonObject)),</a>
<a name="ln479">                this, SLOT(handleGUIUpdateCheck(QJsonObject)),</a>
<a name="ln480">                (Qt::ConnectionType)(Qt::UniqueConnection | Qt::QueuedConnection));</a>
<a name="ln481"> </a>
<a name="ln482">        connect(m_ControlFileParser.data(), SIGNAL(progress(int)),</a>
<a name="ln483">                this, SLOT(handleGUIUpdateCheckProgress(int)),</a>
<a name="ln484">                (Qt::ConnectionType)(Qt::UniqueConnection | Qt::QueuedConnection));</a>
<a name="ln485"> </a>
<a name="ln486">        connect(m_ControlFileParser.data(), SIGNAL(error(short)),</a>
<a name="ln487">                this, SLOT(handleGUIUpdateCheckError(short)),</a>
<a name="ln488">                (Qt::ConnectionType)(Qt::UniqueConnection | Qt::QueuedConnection));</a>
<a name="ln489"> </a>
<a name="ln490">        connect(m_UpdateInformation.data(), SIGNAL(error(short)),</a>
<a name="ln491">                this, SLOT(handleGUIUpdateCheckError(short)),</a>
<a name="ln492">                (Qt::ConnectionType)(Qt::UniqueConnection | Qt::QueuedConnection));</a>
<a name="ln493"> </a>
<a name="ln494">        /// First Check for Update</a>
<a name="ln495">        getMethod(m_UpdateInformation.data(), &quot;getInfo(void)&quot;)</a>
<a name="ln496">        .invoke(m_UpdateInformation.data(), Qt::QueuedConnection);</a>
<a name="ln497"> </a>
<a name="ln498">        if(n_GuiFlag &amp; GuiFlag::ShowBeforeProgress) {</a>
<a name="ln499">            (m_Ui-&gt;mainStack)-&gt;setCurrentIndex(0);</a>
<a name="ln500">            showWidget();</a>
<a name="ln501">        }</a>
<a name="ln502">#endif // NO_GUI</a>
<a name="ln503">    } else if(action == Action::Seed) {</a>
<a name="ln504">#ifndef DECENTRALIZED_UPDATE_ENABLED</a>
<a name="ln505">	b_Started = b_CancelRequested = b_Finished = b_Canceled = false;</a>
<a name="ln506">        emit error(QAppImageUpdateEnums::Error::UnsupportedActionForBuild, action);</a>
<a name="ln507">        return;</a>
<a name="ln508">#else</a>
<a name="ln509">	n_CurrentAction = action;</a>
<a name="ln510"> </a>
<a name="ln511">        m_ControlFileParser-&gt;setUseBittorrent(true);</a>
<a name="ln512"> </a>
<a name="ln513">	connect(m_UpdateInformation.data(), SIGNAL(info(QJsonObject)),</a>
<a name="ln514">                m_ControlFileParser.data(), SLOT(setControlFileUrl(QJsonObject)),</a>
<a name="ln515">                (Qt::ConnectionType)(Qt::UniqueConnection | Qt::QueuedConnection));</a>
<a name="ln516"> </a>
<a name="ln517">        connect(m_ControlFileParser.data(), SIGNAL(receiveControlFile(void)),</a>
<a name="ln518">                m_ControlFileParser.data(), SLOT(getUpdateCheckInformation(void)),</a>
<a name="ln519">                (Qt::ConnectionType)(Qt::UniqueConnection | Qt::QueuedConnection));</a>
<a name="ln520"> </a>
<a name="ln521">        connect(m_ControlFileParser.data(), SIGNAL(updateCheckInformation(QJsonObject)),</a>
<a name="ln522">                m_Seeder.data(), SLOT(start(QJsonObject)),</a>
<a name="ln523">                (Qt::ConnectionType)(Qt::UniqueConnection | Qt::QueuedConnection));</a>
<a name="ln524"> </a>
<a name="ln525">        connect(m_Seeder.data(), SIGNAL(canceled()),</a>
<a name="ln526">                this, SLOT(handleSeedCancel()),</a>
<a name="ln527">                (Qt::ConnectionType)(Qt::UniqueConnection | Qt::QueuedConnection));</a>
<a name="ln528"> </a>
<a name="ln529">        connect(m_Seeder.data(), SIGNAL(error(short)),</a>
<a name="ln530">                this, SLOT(handleSeedError(short)),</a>
<a name="ln531">                (Qt::ConnectionType)(Qt::UniqueConnection | Qt::QueuedConnection));</a>
<a name="ln532"> </a>
<a name="ln533">        connect(m_ControlFileParser.data(), SIGNAL(error(short)),</a>
<a name="ln534">                this, SLOT(handleSeedError(short)),</a>
<a name="ln535">                (Qt::ConnectionType)(Qt::UniqueConnection | Qt::QueuedConnection));</a>
<a name="ln536"> </a>
<a name="ln537">        connect(m_UpdateInformation.data(), SIGNAL(error(short)),</a>
<a name="ln538">                this, SLOT(handleSeedError(short)),</a>
<a name="ln539">                (Qt::ConnectionType)(Qt::UniqueConnection | Qt::QueuedConnection));</a>
<a name="ln540"> </a>
<a name="ln541">        emit started(Action::Seed);</a>
<a name="ln542">        getMethod(m_UpdateInformation.data(), &quot;getInfo(void)&quot;)</a>
<a name="ln543">        .invoke(m_UpdateInformation.data(), Qt::QueuedConnection);</a>
<a name="ln544"> </a>
<a name="ln545">#endif // DECENTRALIZED_UPDATE_ENABLED</a>
<a name="ln546">    } else {</a>
<a name="ln547">        n_CurrentAction = Action::None;</a>
<a name="ln548">        b_Started = b_Running = b_Canceled = false;</a>
<a name="ln549">        emit error(QAppImageUpdateEnums::Error::InvalidAction, n_CurrentAction);</a>
<a name="ln550">    }</a>
<a name="ln551">    return;</a>
<a name="ln552">}</a>
<a name="ln553"> </a>
<a name="ln554">void QAppImageUpdatePrivate::cancel(void) {</a>
<a name="ln555">    if(!b_Started &amp;&amp; !b_Running) {</a>
<a name="ln556">        return;</a>
<a name="ln557">    }</a>
<a name="ln558"> </a>
<a name="ln559">    b_CancelRequested = true;</a>
<a name="ln560">    getMethod(m_DeltaWriter.data(),&quot;cancel()&quot;)</a>
<a name="ln561">    .invoke(m_DeltaWriter.data(), Qt::QueuedConnection);</a>
<a name="ln562">    </a>
<a name="ln563">    return;</a>
<a name="ln564">}</a>
<a name="ln565"> </a>
<a name="ln566"> </a>
<a name="ln567">/// * * *</a>
<a name="ln568">/// Private Slots</a>
<a name="ln569">void QAppImageUpdatePrivate::setCurrentAppImagePath(QString path) {</a>
<a name="ln570">    m_CurrentAppImagePath = path;</a>
<a name="ln571">}</a>
<a name="ln572"> </a>
<a name="ln573">void QAppImageUpdatePrivate::handleUpdateProgress(int percentage,</a>
<a name="ln574">        qint64 bytesReceived,</a>
<a name="ln575">        qint64 bytesTotal,</a>
<a name="ln576">        double speed,</a>
<a name="ln577">        QString units) {</a>
<a name="ln578">    emit progress(percentage, bytesReceived, bytesTotal, speed, units, n_CurrentAction);</a>
<a name="ln579">}</a>
<a name="ln580"> </a>
<a name="ln581">void QAppImageUpdatePrivate::handleGetEmbeddedInfoProgress(int percentage) {</a>
<a name="ln582">    emit progress(percentage, 1, 1, 0, QString(), n_CurrentAction);</a>
<a name="ln583">}</a>
<a name="ln584"> </a>
<a name="ln585">void QAppImageUpdatePrivate::handleCheckForUpdateProgress(int percentage) {</a>
<a name="ln586">    emit progress(percentage, 1, 1, 0, QString(), n_CurrentAction);</a>
<a name="ln587">}</a>
<a name="ln588"> </a>
<a name="ln589">void QAppImageUpdatePrivate::handleGetEmbeddedInfoError(short code) {</a>
<a name="ln590">    b_Canceled = b_Started = b_Running = false;</a>
<a name="ln591">    b_Finished = false;</a>
<a name="ln592">    b_CancelRequested = false;</a>
<a name="ln593">    disconnect(m_UpdateInformation.data(),  &amp;AppImageUpdateInformationPrivate::error,</a>
<a name="ln594">               this, &amp;QAppImageUpdatePrivate::handleGetEmbeddedInfoError);</a>
<a name="ln595">    disconnect(m_UpdateInformation.data(),  &amp;AppImageUpdateInformationPrivate::info,</a>
<a name="ln596">               this, &amp;QAppImageUpdatePrivate::redirectEmbeddedInformation);</a>
<a name="ln597">    disconnect(m_UpdateInformation.data(), &amp;AppImageUpdateInformationPrivate::progress,</a>
<a name="ln598">               this, &amp;QAppImageUpdatePrivate::handleGetEmbeddedInfoProgress);</a>
<a name="ln599">    emit error(code, n_CurrentAction);</a>
<a name="ln600">}</a>
<a name="ln601"> </a>
<a name="ln602">void QAppImageUpdatePrivate::redirectEmbeddedInformation(QJsonObject info) {</a>
<a name="ln603">    b_Canceled = b_Started = b_Running = false;</a>
<a name="ln604">    b_Finished = true;</a>
<a name="ln605">    disconnect(m_UpdateInformation.data(),  &amp;AppImageUpdateInformationPrivate::error,</a>
<a name="ln606">               this, &amp;QAppImageUpdatePrivate::handleGetEmbeddedInfoError);</a>
<a name="ln607">    disconnect(m_UpdateInformation.data(),  &amp;AppImageUpdateInformationPrivate::info,</a>
<a name="ln608">               this, &amp;QAppImageUpdatePrivate::redirectEmbeddedInformation);</a>
<a name="ln609">    disconnect(m_UpdateInformation.data(), &amp;AppImageUpdateInformationPrivate::progress,</a>
<a name="ln610">               this, &amp;QAppImageUpdatePrivate::handleGetEmbeddedInfoProgress);</a>
<a name="ln611"> </a>
<a name="ln612">    if(b_CancelRequested) {</a>
<a name="ln613">        b_CancelRequested = false;</a>
<a name="ln614">        b_Canceled = true;</a>
<a name="ln615">        emit canceled(n_CurrentAction);</a>
<a name="ln616">        return;</a>
<a name="ln617">    }</a>
<a name="ln618">    emit finished(info, n_CurrentAction);</a>
<a name="ln619">}</a>
<a name="ln620"> </a>
<a name="ln621"> </a>
<a name="ln622">void QAppImageUpdatePrivate::handleCheckForUpdateError(short code) {</a>
<a name="ln623">    b_Canceled = b_Started = b_Running = false;</a>
<a name="ln624">    b_Finished = false;</a>
<a name="ln625">    b_CancelRequested = false;</a>
<a name="ln626"> </a>
<a name="ln627">    disconnect(m_UpdateInformation.data(), SIGNAL(info(QJsonObject)),</a>
<a name="ln628">               m_ControlFileParser.data(), SLOT(setControlFileUrl(QJsonObject)));</a>
<a name="ln629">    disconnect(m_ControlFileParser.data(), SIGNAL(receiveControlFile(void)),</a>
<a name="ln630">               m_ControlFileParser.data(), SLOT(getUpdateCheckInformation(void)));</a>
<a name="ln631">    disconnect(m_ControlFileParser.data(), SIGNAL(updateCheckInformation(QJsonObject)),</a>
<a name="ln632">               this, SLOT(redirectUpdateCheck(QJsonObject)));</a>
<a name="ln633">    disconnect(m_ControlFileParser.data(), SIGNAL(error(short)),</a>
<a name="ln634">               this, SLOT(handleCheckForUpdateError(short)));</a>
<a name="ln635">    disconnect(m_UpdateInformation.data(), SIGNAL(error(short)),</a>
<a name="ln636">               this, SLOT(handleCheckForUpdateError(short)));</a>
<a name="ln637">    disconnect(m_ControlFileParser.data(), SIGNAL(progress(int)),</a>
<a name="ln638">               this, SLOT(handleCheckForUpdateProgress(int)));</a>
<a name="ln639"> </a>
<a name="ln640">    emit error(code, n_CurrentAction);</a>
<a name="ln641">}</a>
<a name="ln642"> </a>
<a name="ln643">#ifdef DECENTRALIZED_UPDATE_ENABLED</a>
<a name="ln644">void QAppImageUpdatePrivate::handleSeedError(short code) {</a>
<a name="ln645">    b_Canceled = b_Started = b_Running = false;</a>
<a name="ln646">    b_Finished = false;</a>
<a name="ln647">    b_CancelRequested = false;</a>
<a name="ln648"> </a>
<a name="ln649">    disconnect(m_UpdateInformation.data(), SIGNAL(info(QJsonObject)),</a>
<a name="ln650">               m_ControlFileParser.data(), SLOT(setControlFileUrl(QJsonObject)));</a>
<a name="ln651">    disconnect(m_ControlFileParser.data(), SIGNAL(receiveControlFile(void)),</a>
<a name="ln652">               m_ControlFileParser.data(), SLOT(getUpdateCheckInformation(void)));</a>
<a name="ln653">    disconnect(m_ControlFileParser.data(), SIGNAL(updateCheckInformation(QJsonObject)),</a>
<a name="ln654">                m_Seeder.data(), SLOT(start(QJsonObject)));</a>
<a name="ln655">    disconnect(m_ControlFileParser.data(), SIGNAL(error(short)),</a>
<a name="ln656">               this, SLOT(handleSeedError(short)));</a>
<a name="ln657">    disconnect(m_UpdateInformation.data(), SIGNAL(error(short)),</a>
<a name="ln658">               this, SLOT(handleSeedError(short)));</a>
<a name="ln659">    disconnect(m_Seeder.data(), SIGNAL(canceled()),</a>
<a name="ln660">                this, SLOT(handleSeedCancel()));</a>
<a name="ln661">    disconnect(m_Seeder.data(), SIGNAL(error(short)),</a>
<a name="ln662">                this, SLOT(handleSeedError(short)));</a>
<a name="ln663"> </a>
<a name="ln664">    emit error(code, n_CurrentAction);</a>
<a name="ln665">}</a>
<a name="ln666"> </a>
<a name="ln667">void QAppImageUpdatePrivate::handleSeedCancel() {</a>
<a name="ln668">    b_Canceled = b_Started = b_Running = false;</a>
<a name="ln669">    b_Finished = false;</a>
<a name="ln670">    b_CancelRequested = false;</a>
<a name="ln671"> </a>
<a name="ln672">    disconnect(m_UpdateInformation.data(), SIGNAL(info(QJsonObject)),</a>
<a name="ln673">               m_ControlFileParser.data(), SLOT(setControlFileUrl(QJsonObject)));</a>
<a name="ln674">    disconnect(m_ControlFileParser.data(), SIGNAL(receiveControlFile(void)),</a>
<a name="ln675">               m_ControlFileParser.data(), SLOT(getUpdateCheckInformation(void)));</a>
<a name="ln676">    disconnect(m_ControlFileParser.data(), SIGNAL(updateCheckInformation(QJsonObject)),</a>
<a name="ln677">                m_Seeder.data(), SLOT(start(QJsonObject)));</a>
<a name="ln678">    disconnect(m_ControlFileParser.data(), SIGNAL(error(short)),</a>
<a name="ln679">               this, SLOT(handleSeedError(short)));</a>
<a name="ln680">    disconnect(m_UpdateInformation.data(), SIGNAL(error(short)),</a>
<a name="ln681">               this, SLOT(handleSeedError(short)));</a>
<a name="ln682">    disconnect(m_Seeder.data(), SIGNAL(canceled()),</a>
<a name="ln683">                this, SLOT(handleSeedCancel()));</a>
<a name="ln684">    disconnect(m_Seeder.data(), SIGNAL(error(short)),</a>
<a name="ln685">                this, SLOT(handleSeedError(short)));</a>
<a name="ln686"> </a>
<a name="ln687">    b_Finished = true;</a>
<a name="ln688"> </a>
<a name="ln689">    QJsonObject r { };</a>
<a name="ln690">    emit finished(r, n_CurrentAction);</a>
<a name="ln691">}</a>
<a name="ln692">#endif // DECENTRALIZED_UPDATE_ENABLED</a>
<a name="ln693"> </a>
<a name="ln694">void QAppImageUpdatePrivate::redirectUpdateCheck(QJsonObject info) {</a>
<a name="ln695">    disconnect(m_UpdateInformation.data(), SIGNAL(info(QJsonObject)),</a>
<a name="ln696">               m_ControlFileParser.data(), SLOT(setControlFileUrl(QJsonObject)));</a>
<a name="ln697">    disconnect(m_ControlFileParser.data(), SIGNAL(receiveControlFile(void)),</a>
<a name="ln698">               m_ControlFileParser.data(), SLOT(getUpdateCheckInformation(void)));</a>
<a name="ln699">    disconnect(m_ControlFileParser.data(), SIGNAL(updateCheckInformation(QJsonObject)),</a>
<a name="ln700">               this, SLOT(redirectUpdateCheck(QJsonObject)));</a>
<a name="ln701">    disconnect(m_ControlFileParser.data(), SIGNAL(error(short)),</a>
<a name="ln702">               this, SLOT(handleCheckForUpdateError(short)));</a>
<a name="ln703">    disconnect(m_UpdateInformation.data(), SIGNAL(error(short)),</a>
<a name="ln704">               this, SLOT(handleCheckForUpdateError(short)));</a>
<a name="ln705">    disconnect(m_ControlFileParser.data(), SIGNAL(progress(int)),</a>
<a name="ln706">               this, SLOT(handleCheckForUpdateProgress(int)));</a>
<a name="ln707"> </a>
<a name="ln708"> </a>
<a name="ln709">    // Can this happen without an error?</a>
<a name="ln710">    if(info.isEmpty()) {</a>
<a name="ln711">        return;</a>
<a name="ln712">    }</a>
<a name="ln713"> </a>
<a name="ln714">    auto releaseNotes = info[&quot;ReleaseNotes&quot;].toString();</a>
<a name="ln715">    auto embeddedUpdateInformation = info[&quot;EmbededUpdateInformation&quot;].toObject();</a>
<a name="ln716">    auto oldVersionInformation = embeddedUpdateInformation[&quot;FileInformation&quot;].toObject();</a>
<a name="ln717"> </a>
<a name="ln718">    QString remoteTargetFileSHA1Hash = info[&quot;RemoteTargetFileSHA1Hash&quot;].toString(),</a>
<a name="ln719">            localAppImageSHA1Hash = oldVersionInformation[&quot;AppImageSHA1Hash&quot;].toString(),</a>
<a name="ln720">            localAppImagePath = oldVersionInformation[&quot;AppImageFilePath&quot;].toString();</a>
<a name="ln721"> </a>
<a name="ln722">    bool torrentSupported = info[&quot;TorrentSupported&quot;].toBool();</a>
<a name="ln723">    auto torrentFileUrl = info[&quot;TorrentFileUrl&quot;].toString();</a>
<a name="ln724">    auto targetFileName = info[&quot;RemoteTargetFileName&quot;].toString();</a>
<a name="ln725"> </a>
<a name="ln726">    QJsonObject updateinfo {</a>
<a name="ln727">        { &quot;UpdateAvailable&quot;, localAppImageSHA1Hash != remoteTargetFileSHA1Hash},</a>
<a name="ln728">        { &quot;AbsolutePath&quot;, localAppImagePath},</a>
<a name="ln729">	{ &quot;RemoteTargetFileName&quot;, targetFileName}, </a>
<a name="ln730">	{ &quot;LocalSha1Hash&quot;,  localAppImageSHA1Hash },</a>
<a name="ln731">        { &quot;RemoteSha1Hash&quot;, remoteTargetFileSHA1Hash},</a>
<a name="ln732">        { &quot;ReleaseNotes&quot;, releaseNotes},</a>
<a name="ln733">        { &quot;TorrentSupported&quot;, torrentSupported},</a>
<a name="ln734">	{ &quot;TorrentFileUrl&quot;, torrentFileUrl }</a>
<a name="ln735">    };</a>
<a name="ln736"> </a>
<a name="ln737">    b_Started = b_Running = false;</a>
<a name="ln738">    b_Finished = true;</a>
<a name="ln739">    b_Canceled = false;</a>
<a name="ln740"> </a>
<a name="ln741"> </a>
<a name="ln742">    if(b_CancelRequested) {</a>
<a name="ln743">        b_CancelRequested = false;</a>
<a name="ln744">        b_Canceled = true;</a>
<a name="ln745">        emit canceled(n_CurrentAction);</a>
<a name="ln746">        return;</a>
<a name="ln747">    }</a>
<a name="ln748">    emit finished(updateinfo, n_CurrentAction);</a>
<a name="ln749">}</a>
<a name="ln750"> </a>
<a name="ln751">void QAppImageUpdatePrivate::handleUpdateStart() {</a>
<a name="ln752">    emit started(n_CurrentAction);</a>
<a name="ln753">}</a>
<a name="ln754"> </a>
<a name="ln755">void QAppImageUpdatePrivate::handleUpdateCancel() {</a>
<a name="ln756">    disconnect(m_UpdateInformation.data(), SIGNAL(info(QJsonObject)),</a>
<a name="ln757">               m_ControlFileParser.data(), SLOT(setControlFileUrl(QJsonObject)));</a>
<a name="ln758">    disconnect(m_ControlFileParser.data(), SIGNAL(receiveControlFile(void)),</a>
<a name="ln759">               m_ControlFileParser.data(), SLOT(getZsyncInformation(void)));</a>
<a name="ln760">    disconnect(m_ControlFileParser.data(), &amp;ZsyncRemoteControlFileParserPrivate::zsyncInformation,</a>
<a name="ln761">               m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::setConfiguration);</a>
<a name="ln762">    disconnect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::finishedConfiguring,</a>
<a name="ln763">               m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::start);</a>
<a name="ln764">    disconnect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::finished,</a>
<a name="ln765">               this, &amp;QAppImageUpdatePrivate::handleUpdateFinished);</a>
<a name="ln766">    disconnect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::error,</a>
<a name="ln767">               this, &amp;QAppImageUpdatePrivate::handleUpdateError);</a>
<a name="ln768">    disconnect(m_UpdateInformation.data(), &amp;AppImageUpdateInformationPrivate::error,</a>
<a name="ln769">               this, &amp;QAppImageUpdatePrivate::handleUpdateError);</a>
<a name="ln770">    disconnect(m_ControlFileParser.data(), &amp;ZsyncRemoteControlFileParserPrivate::error,</a>
<a name="ln771">               this, &amp;QAppImageUpdatePrivate::handleUpdateError);</a>
<a name="ln772">    disconnect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::progress,</a>
<a name="ln773">               this, &amp;QAppImageUpdatePrivate::handleUpdateProgress);</a>
<a name="ln774">    disconnect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::canceled,</a>
<a name="ln775">               this, &amp;QAppImageUpdatePrivate::handleUpdateCancel);</a>
<a name="ln776"> </a>
<a name="ln777">    b_Started = b_Running = b_Finished = b_CancelRequested = false;</a>
<a name="ln778">    b_Canceled = true;</a>
<a name="ln779"> </a>
<a name="ln780">    emit canceled(n_CurrentAction);</a>
<a name="ln781"> </a>
<a name="ln782">}</a>
<a name="ln783"> </a>
<a name="ln784">void QAppImageUpdatePrivate::handleUpdateError(short ecode) {</a>
<a name="ln785">    disconnect(m_UpdateInformation.data(), SIGNAL(info(QJsonObject)),</a>
<a name="ln786">               m_ControlFileParser.data(), SLOT(setControlFileUrl(QJsonObject)));</a>
<a name="ln787">    disconnect(m_ControlFileParser.data(), SIGNAL(receiveControlFile(void)),</a>
<a name="ln788">               m_ControlFileParser.data(), SLOT(getZsyncInformation(void)));</a>
<a name="ln789">    disconnect(m_ControlFileParser.data(), &amp;ZsyncRemoteControlFileParserPrivate::zsyncInformation,</a>
<a name="ln790">               m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::setConfiguration);</a>
<a name="ln791">    disconnect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::finishedConfiguring,</a>
<a name="ln792">               m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::start);</a>
<a name="ln793">    disconnect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::finished,</a>
<a name="ln794">               this, &amp;QAppImageUpdatePrivate::handleUpdateFinished);</a>
<a name="ln795">    disconnect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::error,</a>
<a name="ln796">               this, &amp;QAppImageUpdatePrivate::handleUpdateError);</a>
<a name="ln797">    disconnect(m_UpdateInformation.data(), &amp;AppImageUpdateInformationPrivate::error,</a>
<a name="ln798">               this, &amp;QAppImageUpdatePrivate::handleUpdateError);</a>
<a name="ln799">    disconnect(m_ControlFileParser.data(), &amp;ZsyncRemoteControlFileParserPrivate::error,</a>
<a name="ln800">               this, &amp;QAppImageUpdatePrivate::handleUpdateError);</a>
<a name="ln801">    disconnect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::progress,</a>
<a name="ln802">               this, &amp;QAppImageUpdatePrivate::handleUpdateProgress);</a>
<a name="ln803">    disconnect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::canceled,</a>
<a name="ln804">               this, &amp;QAppImageUpdatePrivate::handleUpdateCancel);</a>
<a name="ln805"> </a>
<a name="ln806"> </a>
<a name="ln807">    b_Started = b_Running = b_Finished = false;</a>
<a name="ln808">    b_Canceled = false;</a>
<a name="ln809"> </a>
<a name="ln810">    if(b_CancelRequested) {</a>
<a name="ln811">        b_CancelRequested = false;</a>
<a name="ln812">        b_Canceled = true;</a>
<a name="ln813">        emit canceled(n_CurrentAction);</a>
<a name="ln814">        return;</a>
<a name="ln815">    }</a>
<a name="ln816"> </a>
<a name="ln817">    emit error(ecode, n_CurrentAction);</a>
<a name="ln818">}</a>
<a name="ln819"> </a>
<a name="ln820">void QAppImageUpdatePrivate::handleUpdateFinished(QJsonObject info, QString oldVersionPath) {</a>
<a name="ln821">    disconnect(m_UpdateInformation.data(), SIGNAL(info(QJsonObject)),</a>
<a name="ln822">               m_ControlFileParser.data(), SLOT(setControlFileUrl(QJsonObject)));</a>
<a name="ln823">    disconnect(m_ControlFileParser.data(), SIGNAL(receiveControlFile(void)),</a>
<a name="ln824">               m_ControlFileParser.data(), SLOT(getZsyncInformation(void)));</a>
<a name="ln825">    disconnect(m_ControlFileParser.data(), &amp;ZsyncRemoteControlFileParserPrivate::zsyncInformation,</a>
<a name="ln826">               m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::setConfiguration);</a>
<a name="ln827">    disconnect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::finishedConfiguring,</a>
<a name="ln828">               m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::start);</a>
<a name="ln829">    disconnect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::finished,</a>
<a name="ln830">               this, &amp;QAppImageUpdatePrivate::handleUpdateFinished);</a>
<a name="ln831">    disconnect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::error,</a>
<a name="ln832">               this, &amp;QAppImageUpdatePrivate::handleUpdateError);</a>
<a name="ln833">    disconnect(m_UpdateInformation.data(), &amp;AppImageUpdateInformationPrivate::error,</a>
<a name="ln834">               this, &amp;QAppImageUpdatePrivate::handleUpdateError);</a>
<a name="ln835">    disconnect(m_ControlFileParser.data(), &amp;ZsyncRemoteControlFileParserPrivate::error,</a>
<a name="ln836">               this, &amp;QAppImageUpdatePrivate::handleUpdateError);</a>
<a name="ln837">    disconnect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::progress,</a>
<a name="ln838">               this, &amp;QAppImageUpdatePrivate::handleUpdateProgress);</a>
<a name="ln839">    disconnect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::canceled,</a>
<a name="ln840">               this, &amp;QAppImageUpdatePrivate::handleUpdateCancel);</a>
<a name="ln841"> </a>
<a name="ln842"> </a>
<a name="ln843">    QJsonObject result {</a>
<a name="ln844">        {&quot;OldVersionPath&quot;, oldVersionPath},</a>
<a name="ln845">        {&quot;NewVersionPath&quot;, info[&quot;AbsolutePath&quot;].toString()},</a>
<a name="ln846">        {&quot;NewVersionSha1Hash&quot;, info[&quot;Sha1Hash&quot;].toString()},</a>
<a name="ln847">        {&quot;UsedTorrent&quot;, info[&quot;UsedTorrent&quot;].toBool()},</a>
<a name="ln848">	{&quot;TorrentFileUrl&quot;, info[&quot;TorrentFileUrl&quot;].toString()}</a>
<a name="ln849">    };</a>
<a name="ln850">    b_Started = b_Running = false;</a>
<a name="ln851">    b_Finished = true;</a>
<a name="ln852">    b_Canceled = false;</a>
<a name="ln853"> </a>
<a name="ln854">    if(b_CancelRequested) {</a>
<a name="ln855">        b_CancelRequested = false;</a>
<a name="ln856">        b_Canceled = true;</a>
<a name="ln857">        emit canceled(n_CurrentAction);</a>
<a name="ln858">        return;</a>
<a name="ln859">    }</a>
<a name="ln860"> </a>
<a name="ln861">    emit finished(result, n_CurrentAction);</a>
<a name="ln862">}</a>
<a name="ln863"> </a>
<a name="ln864"> </a>
<a name="ln865">/// GUI Update routines.</a>
<a name="ln866"> </a>
<a name="ln867">#ifndef NO_GUI</a>
<a name="ln868">void QAppImageUpdatePrivate::showWidget() {</a>
<a name="ln869">    if(m_Ui.isNull() || m_UpdaterDialog.isNull()) {</a>
<a name="ln870">        return;</a>
<a name="ln871">    }</a>
<a name="ln872">    if(!(n_GuiFlag &amp; GuiFlag::ShowProgressDialog) &amp;&amp;</a>
<a name="ln873">            (m_Ui-&gt;mainStack)-&gt;currentIndex() != 0) {</a>
<a name="ln874">        return;</a>
<a name="ln875">    }</a>
<a name="ln876">    m_UpdaterDialog-&gt;show();</a>
<a name="ln877">    return;</a>
<a name="ln878">}</a>
<a name="ln879"> </a>
<a name="ln880">void QAppImageUpdatePrivate::handleGUIConfirmationRejected() {</a>
<a name="ln881">    handleGUIUpdateCancel();</a>
<a name="ln882">}</a>
<a name="ln883"> </a>
<a name="ln884">void QAppImageUpdatePrivate::handleGUIConfirmationAccepted() {</a>
<a name="ln885">    doGUIUpdate();</a>
<a name="ln886">}</a>
<a name="ln887"> </a>
<a name="ln888">void QAppImageUpdatePrivate::doGUIUpdate() {</a>
<a name="ln889">    connect(m_UpdateInformation.data(), SIGNAL(info(QJsonObject)),</a>
<a name="ln890">            m_ControlFileParser.data(), SLOT(setControlFileUrl(QJsonObject)),</a>
<a name="ln891">            (Qt::ConnectionType)(Qt::UniqueConnection | Qt::QueuedConnection));</a>
<a name="ln892"> </a>
<a name="ln893">    connect(m_ControlFileParser.data(), SIGNAL(receiveControlFile(void)),</a>
<a name="ln894">            m_ControlFileParser.data(), SLOT(getZsyncInformation(void)),</a>
<a name="ln895">            (Qt::ConnectionType)(Qt::UniqueConnection | Qt::QueuedConnection));</a>
<a name="ln896"> </a>
<a name="ln897">    connect(m_ControlFileParser.data(), &amp;ZsyncRemoteControlFileParserPrivate::zsyncInformation,</a>
<a name="ln898">            m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::setConfiguration,</a>
<a name="ln899">            (Qt::ConnectionType)(Qt::QueuedConnection | Qt::UniqueConnection));</a>
<a name="ln900"> </a>
<a name="ln901">    connect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::finishedConfiguring,</a>
<a name="ln902">            m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::start,</a>
<a name="ln903">            (Qt::ConnectionType)(Qt::QueuedConnection | Qt::UniqueConnection));</a>
<a name="ln904"> </a>
<a name="ln905">    connect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::finished,</a>
<a name="ln906">            this, &amp;QAppImageUpdatePrivate::handleGUIUpdateFinished,</a>
<a name="ln907">            (Qt::ConnectionType)(Qt::QueuedConnection | Qt::UniqueConnection));</a>
<a name="ln908"> </a>
<a name="ln909">    connect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::error,</a>
<a name="ln910">            this, &amp;QAppImageUpdatePrivate::handleGUIUpdateError,</a>
<a name="ln911">            (Qt::ConnectionType)(Qt::QueuedConnection | Qt::UniqueConnection));</a>
<a name="ln912"> </a>
<a name="ln913">    connect(m_UpdateInformation.data(), &amp;AppImageUpdateInformationPrivate::error,</a>
<a name="ln914">            this, &amp;QAppImageUpdatePrivate::handleGUIUpdateError,</a>
<a name="ln915">            (Qt::ConnectionType)(Qt::QueuedConnection | Qt::UniqueConnection));</a>
<a name="ln916"> </a>
<a name="ln917">    connect(m_ControlFileParser.data(), &amp;ZsyncRemoteControlFileParserPrivate::error,</a>
<a name="ln918">            this, &amp;QAppImageUpdatePrivate::handleGUIUpdateError,</a>
<a name="ln919">            (Qt::ConnectionType)(Qt::QueuedConnection | Qt::UniqueConnection));</a>
<a name="ln920"> </a>
<a name="ln921">    connect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::progress,</a>
<a name="ln922">            this, &amp;QAppImageUpdatePrivate::handleGUIUpdateProgress,</a>
<a name="ln923">            (Qt::ConnectionType)(Qt::QueuedConnection | Qt::UniqueConnection));</a>
<a name="ln924"> </a>
<a name="ln925">    connect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::canceled,</a>
<a name="ln926">            this, &amp;QAppImageUpdatePrivate::handleGUIUpdateCancel,</a>
<a name="ln927">            (Qt::ConnectionType)(Qt::QueuedConnection | Qt::UniqueConnection));</a>
<a name="ln928"> </a>
<a name="ln929">    getMethod(m_UpdateInformation.data(), &quot;getInfo(void)&quot;)</a>
<a name="ln930">    .invoke(m_UpdateInformation.data(), Qt::QueuedConnection);</a>
<a name="ln931"> </a>
<a name="ln932"> </a>
<a name="ln933">    showWidget();</a>
<a name="ln934">}</a>
<a name="ln935"> </a>
<a name="ln936">void QAppImageUpdatePrivate::handleGUIUpdateCheck(QJsonObject info) {</a>
<a name="ln937">    disconnect(m_UpdateInformation.data(), SIGNAL(info(QJsonObject)),</a>
<a name="ln938">               m_ControlFileParser.data(), SLOT(setControlFileUrl(QJsonObject)));</a>
<a name="ln939"> </a>
<a name="ln940">    disconnect(m_ControlFileParser.data(), SIGNAL(receiveControlFile(void)),</a>
<a name="ln941">               m_ControlFileParser.data(), SLOT(getUpdateCheckInformation(void)));</a>
<a name="ln942">    disconnect(m_ControlFileParser.data(), SIGNAL(updateCheckInformation(QJsonObject)),</a>
<a name="ln943">               this, SLOT(handleGUIUpdateCheck(QJsonObject)));</a>
<a name="ln944">    disconnect(m_ControlFileParser.data(), SIGNAL(progress(int)),</a>
<a name="ln945">               this, SLOT(handleGUIUpdateCheckProgress(int)));</a>
<a name="ln946">    disconnect(m_ControlFileParser.data(), SIGNAL(error(short)),</a>
<a name="ln947">               this, SLOT(handleGUIUpdateCheckError(short)));</a>
<a name="ln948">    disconnect(m_UpdateInformation.data(), SIGNAL(error(short)),</a>
<a name="ln949">               this, SLOT(handleGUIUpdateCheckError(short)));</a>
<a name="ln950"> </a>
<a name="ln951"> </a>
<a name="ln952">    /// Connect confirmation buttons</a>
<a name="ln953">    connect(m_ConfirmationDialog.data(), &amp;SoftwareUpdateDialog::rejected,</a>
<a name="ln954">            this, &amp;QAppImageUpdatePrivate::handleGUIConfirmationRejected, Qt::QueuedConnection);</a>
<a name="ln955">    connect(m_ConfirmationDialog.data(), &amp;SoftwareUpdateDialog::accepted,</a>
<a name="ln956">            this, &amp;QAppImageUpdatePrivate::handleGUIConfirmationAccepted, Qt::QueuedConnection);</a>
<a name="ln957"> </a>
<a name="ln958"> </a>
<a name="ln959"> </a>
<a name="ln960">    if(b_CancelRequested) {</a>
<a name="ln961">        b_Started = b_Running = b_Finished = false;</a>
<a name="ln962">        b_Canceled = false;</a>
<a name="ln963">        b_CancelRequested = false;</a>
<a name="ln964">        b_Canceled = true;</a>
<a name="ln965">        emit canceled(n_CurrentAction);</a>
<a name="ln966">        return;</a>
<a name="ln967">    }</a>
<a name="ln968"> </a>
<a name="ln969"> </a>
<a name="ln970"> </a>
<a name="ln971">    m_UpdaterDialog-&gt;hide();</a>
<a name="ln972">    m_UpdaterDialog-&gt;move(QGuiApplication::primaryScreen()-&gt;geometry().center() - m_UpdaterDialog-&gt;rect().center());</a>
<a name="ln973">    (m_Ui-&gt;mainStack)-&gt;setCurrentIndex(1);</a>
<a name="ln974"> </a>
<a name="ln975">    auto notes = info[&quot;ReleaseNotes&quot;].toString();</a>
<a name="ln976">    auto embeddedUpdateInformation = info[&quot;EmbededUpdateInformation&quot;].toObject();</a>
<a name="ln977">    auto oldVersionInformation = embeddedUpdateInformation[&quot;FileInformation&quot;].toObject();</a>
<a name="ln978"> </a>
<a name="ln979">    QString remoteTargetFileSHA1Hash = info[&quot;RemoteTargetFileSHA1Hash&quot;].toString(),</a>
<a name="ln980">            localAppImageSHA1Hash = oldVersionInformation[&quot;AppImageSHA1Hash&quot;].toString(),</a>
<a name="ln981">            localAppImagePath = oldVersionInformation[&quot;AppImageFilePath&quot;].toString();</a>
<a name="ln982"> </a>
<a name="ln983">    bool torrentSupported = info[&quot;TorrentSupported&quot;].toBool();</a>
<a name="ln984"> </a>
<a name="ln985">    bool showUpdateDialog = n_GuiFlag &amp; GuiFlag::ShowUpdateConfirmationDialog;</a>
<a name="ln986">    bool showNoUpdateDialog = n_GuiFlag &amp; GuiFlag::NotifyWhenNoUpdateIsAvailable;</a>
<a name="ln987">    bool noConfirmTorrentUsage = n_GuiFlag &amp; GuiFlag::NoConfirmTorrentUsage;</a>
<a name="ln988">    m_UpdaterDialog-&gt;setWindowTitle(QString::fromUtf8(&quot;Updating &quot;) +</a>
<a name="ln989">		    		   (m_ApplicationName.isEmpty() ? </a>
<a name="ln990">				    QFileInfo(localAppImagePath).baseName() : </a>
<a name="ln991">				    m_ApplicationName));</a>
<a name="ln992"> </a>
<a name="ln993">    bool isUpdateAvailable = (localAppImageSHA1Hash != remoteTargetFileSHA1Hash);</a>
<a name="ln994"> </a>
<a name="ln995"> </a>
<a name="ln996">    if(isUpdateAvailable) {</a>
<a name="ln997">        if(torrentSupported) {</a>
<a name="ln998">            bool permission = true;</a>
<a name="ln999">            if(!noConfirmTorrentUsage) {</a>
<a name="ln1000">                QMessageBox box(m_UpdaterDialog.data());</a>
<a name="ln1001">                box.setWindowTitle(QString::fromUtf8(&quot;Torrent Usage Permission&quot;));</a>
<a name="ln1002">                box.setIcon(QMessageBox::Information);</a>
<a name="ln1003">                box.setText(</a>
<a name="ln1004">                    QString::fromUtf8(</a>
<a name="ln1005">                        &quot;It seems that the author of &quot;) +</a>
<a name="ln1006">                    (m_ApplicationName.isEmpty() ? QFileInfo(localAppImagePath).baseName() : </a>
<a name="ln1007">		     m_ApplicationName) +</a>
<a name="ln1008">                    QString::fromUtf8(&quot; supports decentralized update via Bittorrent.&quot;) +</a>
<a name="ln1009">                    QString::fromUtf8(</a>
<a name="ln1010">                        &quot; Do you agree to &lt;b&gt;use Bittorrent for decentralized update?&lt;/b&gt; This is completely optional.&quot;) +</a>
<a name="ln1011">                    QString::fromUtf8(</a>
<a name="ln1012">                        &quot; &lt;b&gt;Please click 'No' if you don't understand the question&lt;/b&gt;.&quot;)</a>
<a name="ln1013">                );</a>
<a name="ln1014">                box.addButton(QMessageBox::Yes);</a>
<a name="ln1015">                box.addButton(QMessageBox::No);</a>
<a name="ln1016">                permission = (box.exec() == QMessageBox::Yes);</a>
<a name="ln1017"> </a>
<a name="ln1018">            }</a>
<a name="ln1019"> </a>
<a name="ln1020">            if(!permission) {</a>
<a name="ln1021">                m_ControlFileParser-&gt;setUseBittorrent(false);</a>
<a name="ln1022">            }</a>
<a name="ln1023">        }</a>
<a name="ln1024">        if(showUpdateDialog) {</a>
<a name="ln1025">            QString oldSha = localAppImageSHA1Hash,</a>
<a name="ln1026">                    newSha = remoteTargetFileSHA1Hash;</a>
<a name="ln1027">            /* we don't need the full sha to show the diff. */</a>
<a name="ln1028">            oldSha.resize(7);</a>
<a name="ln1029">            newSha.resize(7);</a>
<a name="ln1030"> </a>
<a name="ln1031">            oldSha = oldSha.toLower();</a>
<a name="ln1032">            newSha = newSha.toLower();</a>
<a name="ln1033"> </a>
<a name="ln1034">            m_ConfirmationDialog-&gt;init( m_ApplicationName, oldSha, newSha, notes);</a>
<a name="ln1035">        } else {</a>
<a name="ln1036">            // Auto confirm if we are not showing the confirm dialog.</a>
<a name="ln1037">            doGUIUpdate();</a>
<a name="ln1038">        }</a>
<a name="ln1039">    } else {</a>
<a name="ln1040">        if(showNoUpdateDialog) {</a>
<a name="ln1041">            QMessageBox box(m_UpdaterDialog.data());</a>
<a name="ln1042">            box.setWindowTitle(QString::fromUtf8(&quot;No Updates Available!&quot;));</a>
<a name="ln1043">            box.setText(</a>
<a name="ln1044">                QString::fromUtf8(&quot;You are currently using the lastest version of &quot;) +\</a>
<a name="ln1045">		(m_ApplicationName.isEmpty() ? QFileInfo(localAppImagePath).fileName()</a>
<a name="ln1046">		 : m_ApplicationName ) +</a>
<a name="ln1047">                QString::fromUtf8(&quot;.&quot;));</a>
<a name="ln1048">            box.exec();</a>
<a name="ln1049">        }</a>
<a name="ln1050"> </a>
<a name="ln1051">        QJsonObject result {</a>
<a name="ln1052">            {&quot;OldVersionPath&quot;, localAppImagePath},</a>
<a name="ln1053">            {&quot;NewVersionPath&quot;, localAppImagePath},</a>
<a name="ln1054">            {&quot;NewVersionSha1Hash&quot;, localAppImageSHA1Hash},</a>
<a name="ln1055">            {&quot;UsedTorrent&quot;, false}</a>
<a name="ln1056">        };</a>
<a name="ln1057">        b_Started = b_Running = false;</a>
<a name="ln1058">        b_Finished = true;</a>
<a name="ln1059">        b_Canceled = false;</a>
<a name="ln1060"> </a>
<a name="ln1061">        emit finished(result, n_CurrentAction);</a>
<a name="ln1062">    }</a>
<a name="ln1063"> </a>
<a name="ln1064">}</a>
<a name="ln1065"> </a>
<a name="ln1066"> </a>
<a name="ln1067"> </a>
<a name="ln1068">void QAppImageUpdatePrivate::handleGUIUpdateCheckError(short ecode) {</a>
<a name="ln1069">    disconnect(m_UpdateInformation.data(), SIGNAL(info(QJsonObject)),</a>
<a name="ln1070">               m_ControlFileParser.data(), SLOT(setControlFileUrl(QJsonObject)));</a>
<a name="ln1071"> </a>
<a name="ln1072">    disconnect(m_ControlFileParser.data(), SIGNAL(receiveControlFile(void)),</a>
<a name="ln1073">               m_ControlFileParser.data(), SLOT(getUpdateCheckInformation(void)));</a>
<a name="ln1074">    disconnect(m_ControlFileParser.data(), SIGNAL(updateCheckInformation(QJsonObject)),</a>
<a name="ln1075">               this, SLOT(handleGUIUpdateCheck(QJsonObject)));</a>
<a name="ln1076">    disconnect(m_ControlFileParser.data(), SIGNAL(progress(int)),</a>
<a name="ln1077">               this, SLOT(handleGUIUpdateCheckProgress(int)));</a>
<a name="ln1078">    disconnect(m_ControlFileParser.data(), SIGNAL(error(short)),</a>
<a name="ln1079">               this, SLOT(handleGUIUpdateCheckError(short)));</a>
<a name="ln1080">    disconnect(m_UpdateInformation.data(), SIGNAL(error(short)),</a>
<a name="ln1081">               this, SLOT(handleGUIUpdateCheckError(short)));</a>
<a name="ln1082"> </a>
<a name="ln1083">    if(b_CancelRequested) {</a>
<a name="ln1084">        b_Started = b_Running = b_Finished = false;</a>
<a name="ln1085">        b_Canceled = false;</a>
<a name="ln1086">        b_CancelRequested = false;</a>
<a name="ln1087">        b_Canceled = true;</a>
<a name="ln1088">        emit canceled(n_CurrentAction);</a>
<a name="ln1089">        return;</a>
<a name="ln1090">    }</a>
<a name="ln1091"> </a>
<a name="ln1092">    bool show = n_GuiFlag &amp; GuiFlag::ShowErrorDialog;</a>
<a name="ln1093"> </a>
<a name="ln1094"> </a>
<a name="ln1095">    QString errorString = QAppImageUpdatePrivate::errorCodeToDescriptionString(ecode);</a>
<a name="ln1096">    if(ecode == QAppImageUpdateEnums::Error::NoReadPermission ||</a>
<a name="ln1097">            ecode == QAppImageUpdateEnums::Error::NoPermissionToReadSourceFile ||</a>
<a name="ln1098">            ecode == QAppImageUpdateEnums::Error::NoPermissionToReadWriteTargetFile) {</a>
<a name="ln1099">        if(n_GuiFlag &amp; GuiFlag::NoShowErrorDialogOnPermissionErrors) {</a>
<a name="ln1100">            show = false;</a>
<a name="ln1101">        }</a>
<a name="ln1102">    }</a>
<a name="ln1103"> </a>
<a name="ln1104">    if(show) {</a>
<a name="ln1105">        QMessageBox box(m_UpdaterDialog.data());</a>
<a name="ln1106">        box.setWindowTitle(QString::fromUtf8(&quot;Update Failed&quot;));</a>
<a name="ln1107">        box.setIcon(QMessageBox::Critical);</a>
<a name="ln1108">        box.setText(QString::fromUtf8(&quot;Update failed for '&quot;) +</a>
<a name="ln1109">                    QFileInfo(m_CurrentAppImagePath).fileName() +</a>
<a name="ln1110">                    QString::fromUtf8(&quot;': &quot;) + errorString);</a>
<a name="ln1111">        box.exec();</a>
<a name="ln1112">    }</a>
<a name="ln1113">    </a>
<a name="ln1114">    m_UpdaterDialog-&gt;hide(); </a>
<a name="ln1115">    emit error(ecode, n_CurrentAction);</a>
<a name="ln1116">    return;</a>
<a name="ln1117">}</a>
<a name="ln1118"> </a>
<a name="ln1119">void QAppImageUpdatePrivate::handleGUIUpdateCheckProgress(int percentage) {</a>
<a name="ln1120">	(m_Ui-&gt;updateCheckProgressBar)-&gt;setValue(percentage);</a>
<a name="ln1121">	return;</a>
<a name="ln1122">}</a>
<a name="ln1123"> </a>
<a name="ln1124">void QAppImageUpdatePrivate::handleGUIUpdateProgress(int percentage,</a>
<a name="ln1125">        qint64 bytesReceived,</a>
<a name="ln1126">        qint64 bytesTotal,</a>
<a name="ln1127">        double speed,</a>
<a name="ln1128">        QString units) {</a>
<a name="ln1129">    //// Show that we are canceling if cancel was requested.</a>
<a name="ln1130">    if(b_CancelRequested) {</a>
<a name="ln1131">        (m_Ui-&gt;updateSpeedLbl)-&gt;setText(QString::fromUtf8(&quot;Rolling back changes, Please wait... &quot;));</a>
<a name="ln1132">        return;</a>
<a name="ln1133">    }</a>
<a name="ln1134"> </a>
<a name="ln1135">    (m_Ui-&gt;progressBar)-&gt;setValue(percentage);</a>
<a name="ln1136">    double MegaBytesReceived = bytesReceived / 1048576;</a>
<a name="ln1137">    double MegaBytesTotal = bytesTotal / 1048576;</a>
<a name="ln1138">    const QString progressTemplate = QString::fromUtf8(&quot;Updating %1 MiB of %2 MiB at %3 %4...&quot;);</a>
<a name="ln1139">    QString statusText = progressTemplate.arg(MegaBytesReceived).arg(MegaBytesTotal).arg(speed).arg(units);</a>
<a name="ln1140">    (m_Ui-&gt;updateSpeedLbl)-&gt;setText(statusText);</a>
<a name="ln1141">}</a>
<a name="ln1142"> </a>
<a name="ln1143"> </a>
<a name="ln1144">void QAppImageUpdatePrivate::handleGUIUpdateStart() {</a>
<a name="ln1145">    emit started(n_CurrentAction);</a>
<a name="ln1146">}</a>
<a name="ln1147"> </a>
<a name="ln1148">void QAppImageUpdatePrivate::handleGUIUpdateCancel() {</a>
<a name="ln1149">    m_UpdaterDialog-&gt;hide();</a>
<a name="ln1150"> </a>
<a name="ln1151">    disconnect(m_ConfirmationDialog.data(), &amp;SoftwareUpdateDialog::rejected,</a>
<a name="ln1152">               this, &amp;QAppImageUpdatePrivate::handleGUIConfirmationRejected);</a>
<a name="ln1153">    disconnect(m_ConfirmationDialog.data(), &amp;SoftwareUpdateDialog::accepted,</a>
<a name="ln1154">               this, &amp;QAppImageUpdatePrivate::handleGUIConfirmationAccepted);</a>
<a name="ln1155"> </a>
<a name="ln1156">    disconnect(m_UpdateInformation.data(), SIGNAL(info(QJsonObject)),</a>
<a name="ln1157">               m_ControlFileParser.data(), SLOT(setControlFileUrl(QJsonObject)));</a>
<a name="ln1158"> </a>
<a name="ln1159">    disconnect(m_ControlFileParser.data(), SIGNAL(receiveControlFile(void)),</a>
<a name="ln1160">               m_ControlFileParser.data(), SLOT(getZsyncInformation(void)));</a>
<a name="ln1161"> </a>
<a name="ln1162">    disconnect(m_ControlFileParser.data(), &amp;ZsyncRemoteControlFileParserPrivate::zsyncInformation,</a>
<a name="ln1163">               m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::setConfiguration);</a>
<a name="ln1164"> </a>
<a name="ln1165">    disconnect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::finishedConfiguring,</a>
<a name="ln1166">               m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::start);</a>
<a name="ln1167"> </a>
<a name="ln1168">    disconnect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::finished,</a>
<a name="ln1169">               this, &amp;QAppImageUpdatePrivate::handleGUIUpdateFinished);</a>
<a name="ln1170"> </a>
<a name="ln1171">    disconnect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::error,</a>
<a name="ln1172">               this, &amp;QAppImageUpdatePrivate::handleGUIUpdateError);</a>
<a name="ln1173"> </a>
<a name="ln1174">    disconnect(m_UpdateInformation.data(), &amp;AppImageUpdateInformationPrivate::error,</a>
<a name="ln1175">               this, &amp;QAppImageUpdatePrivate::handleGUIUpdateError);</a>
<a name="ln1176"> </a>
<a name="ln1177">    disconnect(m_ControlFileParser.data(), &amp;ZsyncRemoteControlFileParserPrivate::error,</a>
<a name="ln1178">               this, &amp;QAppImageUpdatePrivate::handleGUIUpdateError);</a>
<a name="ln1179"> </a>
<a name="ln1180">    disconnect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::progress,</a>
<a name="ln1181">               this, &amp;QAppImageUpdatePrivate::handleGUIUpdateProgress);</a>
<a name="ln1182"> </a>
<a name="ln1183">    disconnect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::canceled,</a>
<a name="ln1184">               this, &amp;QAppImageUpdatePrivate::handleGUIUpdateCancel);</a>
<a name="ln1185"> </a>
<a name="ln1186">    b_Started = b_Running = b_Finished = b_CancelRequested = false;</a>
<a name="ln1187">    b_Canceled = true;</a>
<a name="ln1188"> </a>
<a name="ln1189">    emit canceled(n_CurrentAction);</a>
<a name="ln1190">}</a>
<a name="ln1191"> </a>
<a name="ln1192">void QAppImageUpdatePrivate::handleGUIUpdateError(short ecode) {</a>
<a name="ln1193">    disconnect(m_ConfirmationDialog.data(), &amp;SoftwareUpdateDialog::rejected,</a>
<a name="ln1194">               this, &amp;QAppImageUpdatePrivate::handleGUIConfirmationRejected);</a>
<a name="ln1195">    disconnect(m_ConfirmationDialog.data(), &amp;SoftwareUpdateDialog::accepted,</a>
<a name="ln1196">               this, &amp;QAppImageUpdatePrivate::handleGUIConfirmationAccepted);</a>
<a name="ln1197"> </a>
<a name="ln1198">    disconnect(m_UpdateInformation.data(), SIGNAL(info(QJsonObject)),</a>
<a name="ln1199">               m_ControlFileParser.data(), SLOT(setControlFileUrl(QJsonObject)));</a>
<a name="ln1200"> </a>
<a name="ln1201">    disconnect(m_ControlFileParser.data(), SIGNAL(receiveControlFile(void)),</a>
<a name="ln1202">               m_ControlFileParser.data(), SLOT(getZsyncInformation(void)));</a>
<a name="ln1203"> </a>
<a name="ln1204">    disconnect(m_ControlFileParser.data(), &amp;ZsyncRemoteControlFileParserPrivate::zsyncInformation,</a>
<a name="ln1205">               m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::setConfiguration);</a>
<a name="ln1206"> </a>
<a name="ln1207">    disconnect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::finishedConfiguring,</a>
<a name="ln1208">               m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::start);</a>
<a name="ln1209"> </a>
<a name="ln1210">    disconnect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::finished,</a>
<a name="ln1211">               this, &amp;QAppImageUpdatePrivate::handleGUIUpdateFinished);</a>
<a name="ln1212"> </a>
<a name="ln1213">    disconnect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::error,</a>
<a name="ln1214">               this, &amp;QAppImageUpdatePrivate::handleGUIUpdateError);</a>
<a name="ln1215"> </a>
<a name="ln1216">    disconnect(m_UpdateInformation.data(), &amp;AppImageUpdateInformationPrivate::error,</a>
<a name="ln1217">               this, &amp;QAppImageUpdatePrivate::handleGUIUpdateError);</a>
<a name="ln1218"> </a>
<a name="ln1219">    disconnect(m_ControlFileParser.data(), &amp;ZsyncRemoteControlFileParserPrivate::error,</a>
<a name="ln1220">               this, &amp;QAppImageUpdatePrivate::handleGUIUpdateError);</a>
<a name="ln1221"> </a>
<a name="ln1222">    disconnect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::progress,</a>
<a name="ln1223">               this, &amp;QAppImageUpdatePrivate::handleGUIUpdateProgress);</a>
<a name="ln1224"> </a>
<a name="ln1225">    disconnect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::canceled,</a>
<a name="ln1226">               this, &amp;QAppImageUpdatePrivate::handleGUIUpdateCancel);</a>
<a name="ln1227"> </a>
<a name="ln1228"> </a>
<a name="ln1229">    b_Started = b_Running = b_Finished = false;</a>
<a name="ln1230">    b_Canceled = false;</a>
<a name="ln1231"> </a>
<a name="ln1232">    if(b_CancelRequested) {</a>
<a name="ln1233">        b_CancelRequested = false;</a>
<a name="ln1234">        b_Canceled = true;</a>
<a name="ln1235">        emit canceled(n_CurrentAction);</a>
<a name="ln1236">        return;</a>
<a name="ln1237">    }</a>
<a name="ln1238"> </a>
<a name="ln1239">    bool show = n_GuiFlag &amp; GuiFlag::ShowErrorDialog;</a>
<a name="ln1240"> </a>
<a name="ln1241"> </a>
<a name="ln1242">    QString errorString = QAppImageUpdatePrivate::errorCodeToDescriptionString(ecode);</a>
<a name="ln1243">    if(ecode == QAppImageUpdateEnums::Error::NoReadPermission ||</a>
<a name="ln1244">            ecode == QAppImageUpdateEnums::Error::NoPermissionToReadSourceFile ||</a>
<a name="ln1245">            ecode == QAppImageUpdateEnums::Error::NoPermissionToReadWriteTargetFile) {</a>
<a name="ln1246">        if(n_GuiFlag &amp; GuiFlag::NoShowErrorDialogOnPermissionErrors) {</a>
<a name="ln1247">            show = false;</a>
<a name="ln1248">        }</a>
<a name="ln1249">    }</a>
<a name="ln1250"> </a>
<a name="ln1251">    if(show) {</a>
<a name="ln1252">        QMessageBox box(m_UpdaterDialog.data());</a>
<a name="ln1253">        box.setWindowTitle(QString::fromUtf8(&quot;Update Failed&quot;));</a>
<a name="ln1254">        box.setIcon(QMessageBox::Critical);</a>
<a name="ln1255">        box.setText(QString::fromUtf8(&quot;Update failed for '&quot;) +</a>
<a name="ln1256">                    (m_ApplicationName.isEmpty() ? QFileInfo(m_CurrentAppImagePath).fileName() : m_ApplicationName) +</a>
<a name="ln1257">                    QString::fromUtf8(&quot;': &quot;) + errorString);</a>
<a name="ln1258">        box.exec();</a>
<a name="ln1259">    }</a>
<a name="ln1260"> </a>
<a name="ln1261"> </a>
<a name="ln1262">    emit error(ecode, n_CurrentAction);</a>
<a name="ln1263">    m_UpdaterDialog-&gt;hide();</a>
<a name="ln1264">    return;</a>
<a name="ln1265">}</a>
<a name="ln1266"> </a>
<a name="ln1267">void QAppImageUpdatePrivate::handleGUIUpdateFinished(QJsonObject info, QString oldVersionPath) {</a>
<a name="ln1268">    disconnect(m_ConfirmationDialog.data(), &amp;SoftwareUpdateDialog::rejected,</a>
<a name="ln1269">               this, &amp;QAppImageUpdatePrivate::handleGUIConfirmationRejected);</a>
<a name="ln1270">    disconnect(m_ConfirmationDialog.data(), &amp;SoftwareUpdateDialog::accepted,</a>
<a name="ln1271">               this, &amp;QAppImageUpdatePrivate::handleGUIConfirmationAccepted);</a>
<a name="ln1272"> </a>
<a name="ln1273">    disconnect(m_UpdateInformation.data(), SIGNAL(info(QJsonObject)),</a>
<a name="ln1274">               m_ControlFileParser.data(), SLOT(setControlFileUrl(QJsonObject)));</a>
<a name="ln1275"> </a>
<a name="ln1276">    disconnect(m_ControlFileParser.data(), SIGNAL(receiveControlFile(void)),</a>
<a name="ln1277">               m_ControlFileParser.data(), SLOT(getZsyncInformation(void)));</a>
<a name="ln1278"> </a>
<a name="ln1279">    disconnect(m_ControlFileParser.data(), &amp;ZsyncRemoteControlFileParserPrivate::zsyncInformation,</a>
<a name="ln1280">               m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::setConfiguration);</a>
<a name="ln1281"> </a>
<a name="ln1282">    disconnect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::finishedConfiguring,</a>
<a name="ln1283">               m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::start);</a>
<a name="ln1284"> </a>
<a name="ln1285">    disconnect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::finished,</a>
<a name="ln1286">               this, &amp;QAppImageUpdatePrivate::handleGUIUpdateFinished);</a>
<a name="ln1287"> </a>
<a name="ln1288">    disconnect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::error,</a>
<a name="ln1289">               this, &amp;QAppImageUpdatePrivate::handleGUIUpdateError);</a>
<a name="ln1290"> </a>
<a name="ln1291">    disconnect(m_UpdateInformation.data(), &amp;AppImageUpdateInformationPrivate::error,</a>
<a name="ln1292">               this, &amp;QAppImageUpdatePrivate::handleGUIUpdateError);</a>
<a name="ln1293"> </a>
<a name="ln1294">    disconnect(m_ControlFileParser.data(), &amp;ZsyncRemoteControlFileParserPrivate::error,</a>
<a name="ln1295">               this, &amp;QAppImageUpdatePrivate::handleGUIUpdateError);</a>
<a name="ln1296"> </a>
<a name="ln1297">    disconnect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::progress,</a>
<a name="ln1298">               this, &amp;QAppImageUpdatePrivate::handleGUIUpdateProgress);</a>
<a name="ln1299"> </a>
<a name="ln1300">    disconnect(m_DeltaWriter.data(), &amp;ZsyncWriterPrivate::canceled,</a>
<a name="ln1301">               this, &amp;QAppImageUpdatePrivate::handleGUIUpdateCancel);</a>
<a name="ln1302"> </a>
<a name="ln1303"> </a>
<a name="ln1304"> </a>
<a name="ln1305">    QJsonObject result {</a>
<a name="ln1306">        {&quot;OldVersionPath&quot;, oldVersionPath},</a>
<a name="ln1307">        {&quot;NewVersionPath&quot;, info[&quot;AbsolutePath&quot;].toString()},</a>
<a name="ln1308">        {&quot;NewVersionSha1Hash&quot;, info[&quot;Sha1Hash&quot;].toString()},</a>
<a name="ln1309">        {&quot;UsedTorrent&quot;, info[&quot;UsedTorrent&quot;].toBool()}</a>
<a name="ln1310">    };</a>
<a name="ln1311">    b_Started = b_Running = false;</a>
<a name="ln1312">    b_Finished = true;</a>
<a name="ln1313">    b_Canceled = false;</a>
<a name="ln1314"> </a>
<a name="ln1315">    if(b_CancelRequested) {</a>
<a name="ln1316">        QFile::remove(info[&quot;AbsolutePath&quot;].toString());</a>
<a name="ln1317"> </a>
<a name="ln1318">        b_CancelRequested = false;</a>
<a name="ln1319">        b_Canceled = true;</a>
<a name="ln1320">        emit canceled(n_CurrentAction);</a>
<a name="ln1321">        return;</a>
<a name="ln1322">    }</a>
<a name="ln1323"> </a>
<a name="ln1324">    (m_Ui-&gt;updateSpeedLbl)-&gt;setText(QString::fromUtf8(&quot;Finalizing Update... &quot;));</a>
<a name="ln1325"> </a>
<a name="ln1326">    bool execute = false;</a>
<a name="ln1327">    bool show = n_GuiFlag &amp; GuiFlag::ShowFinishedDialog;</a>
<a name="ln1328"> </a>
<a name="ln1329">    if(show) {</a>
<a name="ln1330">        auto curinfo = QFileInfo(oldVersionPath);</a>
<a name="ln1331">        QString currentAppImageName = curinfo.fileName();</a>
<a name="ln1332">        QString currentAppImageAbsPath = curinfo.absolutePath();</a>
<a name="ln1333"> </a>
<a name="ln1334">        QMessageBox box(m_UpdaterDialog.data());</a>
<a name="ln1335">        box.setWindowTitle(QString::fromUtf8(&quot;Update Completed&quot;));</a>
<a name="ln1336">        box.setIcon(QMessageBox::Information);</a>
<a name="ln1337">        box.setDetailedText(</a>
<a name="ln1338">            QString::fromUtf8(&quot;Old version is at: &quot;) +</a>
<a name="ln1339">            currentAppImageAbsPath + QString::fromUtf8(&quot;/&quot;) + currentAppImageName +</a>
<a name="ln1340">            QString::fromUtf8(&quot;\n\n&quot;) +</a>
<a name="ln1341">            QString::fromUtf8(&quot;New version is saved at: &quot;) +</a>
<a name="ln1342">            result[&quot;NewVersionPath&quot;].toString());</a>
<a name="ln1343">        box.setText(QString::fromUtf8(&quot;Update completed successfully for &lt;b&gt;&quot;) +</a>
<a name="ln1344">                    (m_ApplicationName.isEmpty() ? currentAppImageName : m_ApplicationName) +</a>
<a name="ln1345">                    QString::fromUtf8(&quot;&lt;/b&gt;, do you want to launch the new version? View details for more information.&quot;));</a>
<a name="ln1346">        box.addButton(QMessageBox::Yes);</a>
<a name="ln1347">        box.addButton(QMessageBox::No);</a>
<a name="ln1348">        execute = (box.exec() == QMessageBox::Yes);</a>
<a name="ln1349">    }</a>
<a name="ln1350"> </a>
<a name="ln1351">    if(execute) {</a>
<a name="ln1352">        QFileInfo info(result[&quot;NewVersionPath&quot;].toString());</a>
<a name="ln1353">        if(!info.isExecutable()) {</a>
<a name="ln1354">            {</a>
<a name="ln1355">                QFile file(result[&quot;NewVersionPath&quot;].toString());</a>
<a name="ln1356">                file.setPermissions(QFileDevice::ExeUser |</a>
<a name="ln1357">                                    QFileDevice::ExeOther|</a>
<a name="ln1358">                                    QFileDevice::ExeGroup|</a>
<a name="ln1359">                                    info.permissions());</a>
<a name="ln1360">            }</a>
<a name="ln1361">        }</a>
<a name="ln1362">	</a>
<a name="ln1363">	m_UpdaterDialog-&gt;hide();</a>
<a name="ln1364">        QProcess::startDetached(result[&quot;NewVersionPath&quot;].toString(), QStringList());</a>
<a name="ln1365">        </a>
<a name="ln1366">	emit quit();</a>
<a name="ln1367">    }</a>
<a name="ln1368">    m_UpdaterDialog-&gt;hide();</a>
<a name="ln1369">    emit finished(result, n_CurrentAction);</a>
<a name="ln1370">    return;</a>
<a name="ln1371">}</a>
<a name="ln1372">#endif // NOT NO_GUI</a>
<a name="ln1373"> </a>
<a name="ln1374">//// Static Methods</a>
<a name="ln1375">QString QAppImageUpdatePrivate::errorCodeToString(short errorCode) {</a>
<a name="ln1376">    QString ret = &quot;QAppImageUpdate::Error::&quot;;</a>
<a name="ln1377">    switch(errorCode) {</a>
<a name="ln1378">    case QAppImageUpdateEnums::Error::NoAppimagePathGiven:</a>
<a name="ln1379">        ret += &quot;NoAppImagePathGiven&quot;;</a>
<a name="ln1380">        break;</a>
<a name="ln1381">    case QAppImageUpdateEnums::Error::AppimageNotReadable:</a>
<a name="ln1382">        ret += &quot;AppImageNotReadable&quot;;</a>
<a name="ln1383">        break;</a>
<a name="ln1384">    case QAppImageUpdateEnums::Error::NoReadPermission:</a>
<a name="ln1385">        ret += &quot;NoReadPermission&quot;;</a>
<a name="ln1386">        break;</a>
<a name="ln1387">    case QAppImageUpdateEnums::Error::AppimageNotFound:</a>
<a name="ln1388">        ret += &quot;AppimageNotFound&quot;;</a>
<a name="ln1389">        break;</a>
<a name="ln1390">    case QAppImageUpdateEnums::Error::CannotOpenAppimage:</a>
<a name="ln1391">        ret += &quot;CannnotOpenAppimage&quot;;</a>
<a name="ln1392">        break;</a>
<a name="ln1393">    case QAppImageUpdateEnums::Error::EmptyUpdateInformation:</a>
<a name="ln1394">        ret += &quot;EmptyUpdateInformation&quot;;</a>
<a name="ln1395">        break;</a>
<a name="ln1396">    case QAppImageUpdateEnums::Error::InvalidAppimageType:</a>
<a name="ln1397">        ret += &quot;InvalidAppimageType&quot;;</a>
<a name="ln1398">        break;</a>
<a name="ln1399">    case QAppImageUpdateEnums::Error::InvalidMagicBytes:</a>
<a name="ln1400">        ret += &quot;InvalidMagicBytes&quot;;</a>
<a name="ln1401">        break;</a>
<a name="ln1402">    case QAppImageUpdateEnums::Error::InvalidUpdateInformation:</a>
<a name="ln1403">        ret += &quot;InvalidUpdateInformation&quot;;</a>
<a name="ln1404">        break;</a>
<a name="ln1405">    case QAppImageUpdateEnums::Error::NotEnoughMemory:</a>
<a name="ln1406">        ret += &quot;NotEnoughMemory&quot;;</a>
<a name="ln1407">        break;</a>
<a name="ln1408">    case QAppImageUpdateEnums::Error::SectionHeaderNotFound:</a>
<a name="ln1409">        ret += &quot;SectionHeaderNotFound&quot;;</a>
<a name="ln1410">        break;</a>
<a name="ln1411">    case QAppImageUpdateEnums::Error::UnsupportedElfFormat:</a>
<a name="ln1412">        ret += &quot;UnsupportedElfFormat&quot;;</a>
<a name="ln1413">        break;</a>
<a name="ln1414">    case QAppImageUpdateEnums::Error::UnsupportedTransport:</a>
<a name="ln1415">        ret += &quot;UnsupportedTransport&quot;;</a>
<a name="ln1416">        break;</a>
<a name="ln1417">    case QAppImageUpdateEnums::Error::UnknownNetworkError:</a>
<a name="ln1418">        ret += &quot;UnknownNetworkError&quot;;</a>
<a name="ln1419">        break;</a>
<a name="ln1420">    case QAppImageUpdateEnums::Error::IoReadError:</a>
<a name="ln1421">        ret += &quot;IoReadError&quot;;</a>
<a name="ln1422">        break;</a>
<a name="ln1423">    case QAppImageUpdateEnums::Error::ErrorResponseCode:</a>
<a name="ln1424">        ret += &quot;ErrorResponseCode&quot;;</a>
<a name="ln1425">        break;</a>
<a name="ln1426">    case QAppImageUpdateEnums::Error::GithubApiRateLimitReached:</a>
<a name="ln1427">        ret += &quot;GithubApiRateLimitReached&quot;;</a>
<a name="ln1428">        break;</a>
<a name="ln1429">    case QAppImageUpdateEnums::Error::NoMarkerFoundInControlFile:</a>
<a name="ln1430">        ret += &quot;NoMarkerFoundInControlFile&quot;;</a>
<a name="ln1431">        break;</a>
<a name="ln1432">    case QAppImageUpdateEnums::Error::InvalidZsyncHeadersNumber:</a>
<a name="ln1433">        ret += &quot;InvalidZsyncHeadersNumber&quot;;</a>
<a name="ln1434">        break;</a>
<a name="ln1435">    case QAppImageUpdateEnums::Error::InvalidZsyncMakeVersion:</a>
<a name="ln1436">        ret += &quot;InvalidZsyncMakeVersion&quot;;</a>
<a name="ln1437">        break;</a>
<a name="ln1438">    case QAppImageUpdateEnums::Error::InvalidZsyncTargetFilename:</a>
<a name="ln1439">        ret += &quot;InvalidZsyncTargetFilename&quot;;</a>
<a name="ln1440">        break;</a>
<a name="ln1441">    case QAppImageUpdateEnums::Error::InvalidZsyncMtime:</a>
<a name="ln1442">        ret += &quot;InvalidZsyncMtime&quot;;</a>
<a name="ln1443">        break;</a>
<a name="ln1444">    case QAppImageUpdateEnums::Error::InvalidZsyncBlocksize:</a>
<a name="ln1445">        ret += &quot;InvalidZsyncBlocksize&quot;;</a>
<a name="ln1446">        break;</a>
<a name="ln1447">    case QAppImageUpdateEnums::Error::InvalidTargetFileLength:</a>
<a name="ln1448">        ret += &quot;InvalidTargetFileLength&quot;;</a>
<a name="ln1449">        break;</a>
<a name="ln1450">    case QAppImageUpdateEnums::Error::InvalidHashLengthLine:</a>
<a name="ln1451">        ret += &quot;InvalidHashLengthLine&quot;;</a>
<a name="ln1452">        break;</a>
<a name="ln1453">    case QAppImageUpdateEnums::Error::InvalidHashLengths:</a>
<a name="ln1454">        ret += &quot;InvalidHashLengths&quot;;</a>
<a name="ln1455">        break;</a>
<a name="ln1456">    case QAppImageUpdateEnums::Error::InvalidTargetFileUrl:</a>
<a name="ln1457">        ret += &quot;InvalidTargetFileUrl&quot;;</a>
<a name="ln1458">        break;</a>
<a name="ln1459">    case QAppImageUpdateEnums::Error::InvalidTargetFileSha1:</a>
<a name="ln1460">        ret += &quot;InvalidTargetFileSha1&quot;;</a>
<a name="ln1461">        break;</a>
<a name="ln1462">    case QAppImageUpdateEnums::Error::ConnectionRefusedError:</a>
<a name="ln1463">        ret += &quot;ConnectionRefusedError&quot;;</a>
<a name="ln1464">        break;</a>
<a name="ln1465">    case QAppImageUpdateEnums::Error::RemoteHostClosedError:</a>
<a name="ln1466">        ret += &quot;RemoteHostClosedError&quot;;</a>
<a name="ln1467">        break;</a>
<a name="ln1468">    case QAppImageUpdateEnums::Error::HostNotFoundError:</a>
<a name="ln1469">        ret += &quot;HostNotFoundError&quot;;</a>
<a name="ln1470">        break;</a>
<a name="ln1471">    case QAppImageUpdateEnums::Error::TimeoutError:</a>
<a name="ln1472">        ret += &quot;TimeoutError&quot;;</a>
<a name="ln1473">        break;</a>
<a name="ln1474">    case QAppImageUpdateEnums::Error::OperationCanceledError:</a>
<a name="ln1475">        ret += &quot;OperationCanceledError&quot;;</a>
<a name="ln1476">        break;</a>
<a name="ln1477">    case QAppImageUpdateEnums::Error::SslHandshakeFailedError:</a>
<a name="ln1478">        ret += &quot;SslHandshakeFailedError&quot;;</a>
<a name="ln1479">        break;</a>
<a name="ln1480">    case QAppImageUpdateEnums::Error::TemporaryNetworkFailureError:</a>
<a name="ln1481">        ret += &quot;TemporaryNetworkFailureError&quot;;</a>
<a name="ln1482">        break;</a>
<a name="ln1483">    case QAppImageUpdateEnums::Error::NetworkSessionFailedError:</a>
<a name="ln1484">        ret += &quot;NetworkSessionFailedError&quot;;</a>
<a name="ln1485">        break;</a>
<a name="ln1486">    case QAppImageUpdateEnums::Error::BackgroundRequestNotAllowedError:</a>
<a name="ln1487">        ret += &quot;BackgroundRequestNotAllowedError&quot;;</a>
<a name="ln1488">        break;</a>
<a name="ln1489">    case QAppImageUpdateEnums::Error::TooManyRedirectsError:</a>
<a name="ln1490">        ret += &quot;TooManyRedirectsError&quot;;</a>
<a name="ln1491">        break;</a>
<a name="ln1492">    case QAppImageUpdateEnums::Error::InsecureRedirectError:</a>
<a name="ln1493">        ret += &quot;InsecureRedirectError&quot;;</a>
<a name="ln1494">        break;</a>
<a name="ln1495">    case QAppImageUpdateEnums::Error::ProxyConnectionRefusedError:</a>
<a name="ln1496">        ret += &quot;ProxyConnectionRefusedError&quot;;</a>
<a name="ln1497">        break;</a>
<a name="ln1498">    case QAppImageUpdateEnums::Error::ProxyConnectionClosedError:</a>
<a name="ln1499">        ret += &quot;ProxyConnectionClosedError&quot;;</a>
<a name="ln1500">        break;</a>
<a name="ln1501">    case QAppImageUpdateEnums::Error::ProxyNotFoundError:</a>
<a name="ln1502">        ret += &quot;ProxyNotFoundError&quot;;</a>
<a name="ln1503">        break;</a>
<a name="ln1504">    case QAppImageUpdateEnums::Error::ProxyTimeoutError:</a>
<a name="ln1505">        ret += &quot;ProxyTimeoutError&quot;;</a>
<a name="ln1506">        break;</a>
<a name="ln1507">    case QAppImageUpdateEnums::Error::ProxyAuthenticationRequiredError:</a>
<a name="ln1508">        ret += &quot;ProxyAuthenticationRequiredError&quot;;</a>
<a name="ln1509">        break;</a>
<a name="ln1510">    case QAppImageUpdateEnums::Error::ContentAccessDenied:</a>
<a name="ln1511">        ret += &quot;ContentAccessDenied&quot;;</a>
<a name="ln1512">        break;</a>
<a name="ln1513">    case QAppImageUpdateEnums::Error::ContentOperationNotPermittedError:</a>
<a name="ln1514">        ret += &quot;ContentOperationNotPermittedError&quot;;</a>
<a name="ln1515">        break;</a>
<a name="ln1516">    case QAppImageUpdateEnums::Error::ContentNotFoundError:</a>
<a name="ln1517">        ret += &quot;ContentNotFoundError&quot;;</a>
<a name="ln1518">        break;</a>
<a name="ln1519">    case QAppImageUpdateEnums::Error::AuthenticationRequiredError:</a>
<a name="ln1520">        ret += &quot;AuthenticationRequiredError&quot;;</a>
<a name="ln1521">        break;</a>
<a name="ln1522">    case QAppImageUpdateEnums::Error::ContentReSendError:</a>
<a name="ln1523">        ret += &quot;ContentReSendError&quot;;</a>
<a name="ln1524">        break;</a>
<a name="ln1525">    case QAppImageUpdateEnums::Error::ContentConflictError:</a>
<a name="ln1526">        ret += &quot;ContentConflictError&quot;;</a>
<a name="ln1527">        break;</a>
<a name="ln1528">    case QAppImageUpdateEnums::Error::ContentGoneError:</a>
<a name="ln1529">        ret += &quot;ContentGoneError&quot;;</a>
<a name="ln1530">        break;</a>
<a name="ln1531">    case QAppImageUpdateEnums::Error::InternalServerError:</a>
<a name="ln1532">        ret += &quot;InternalServerError&quot;;</a>
<a name="ln1533">        break;</a>
<a name="ln1534">    case QAppImageUpdateEnums::Error::OperationNotImplementedError:</a>
<a name="ln1535">        ret += &quot;OperationNotImplementedError&quot;;</a>
<a name="ln1536">        break;</a>
<a name="ln1537">    case QAppImageUpdateEnums::Error::ServiceUnavailableError:</a>
<a name="ln1538">        ret += &quot;ServiceUnavailableError&quot;;</a>
<a name="ln1539">        break;</a>
<a name="ln1540">    case QAppImageUpdateEnums::Error::ProtocolUnknownError:</a>
<a name="ln1541">        ret += &quot;ProtocolUnknownError&quot;;</a>
<a name="ln1542">        break;</a>
<a name="ln1543">    case QAppImageUpdateEnums::Error::ProtocolInvalidOperationError:</a>
<a name="ln1544">        ret += &quot;ProtocolInvalidOperationError&quot;;</a>
<a name="ln1545">        break;</a>
<a name="ln1546">    case QAppImageUpdateEnums::Error::UnknownProxyError:</a>
<a name="ln1547">        ret += &quot;UnknownProxyError&quot;;</a>
<a name="ln1548">        break;</a>
<a name="ln1549">    case QAppImageUpdateEnums::Error::UnknownContentError:</a>
<a name="ln1550">        ret += &quot;UnknownContentError&quot;;</a>
<a name="ln1551">        break;</a>
<a name="ln1552">    case QAppImageUpdateEnums::Error::ProtocolFailure:</a>
<a name="ln1553">        ret += &quot;ProtocolFailure&quot;;</a>
<a name="ln1554">        break;</a>
<a name="ln1555">    case QAppImageUpdateEnums::Error::UnknownServerError:</a>
<a name="ln1556">        ret += &quot;UnknownServerError&quot;;</a>
<a name="ln1557">        break;</a>
<a name="ln1558">    case QAppImageUpdateEnums::Error::ZsyncControlFileNotFound:</a>
<a name="ln1559">        ret += &quot;ZsyncControlFileNotFound&quot;;</a>
<a name="ln1560">        break;</a>
<a name="ln1561">    case QAppImageUpdateEnums::Error::HashTableNotAllocated:</a>
<a name="ln1562">        ret += &quot;HashTableNotAllocated&quot;;</a>
<a name="ln1563">        break;</a>
<a name="ln1564">    case QAppImageUpdateEnums::Error::InvalidTargetFileChecksumBlocks:</a>
<a name="ln1565">        ret += &quot;InvalidTargetFileChecksumBlocks&quot;;</a>
<a name="ln1566">        break;</a>
<a name="ln1567">    case QAppImageUpdateEnums::Error::CannotConstructHashTable:</a>
<a name="ln1568">        ret += &quot;CannotConstructHashTable&quot;;</a>
<a name="ln1569">        break;</a>
<a name="ln1570">    case QAppImageUpdateEnums::Error::CannotOpenTargetFileChecksumBlocks:</a>
<a name="ln1571">        ret += &quot;CannotOpenTargetFileChecksumBlocks&quot;;</a>
<a name="ln1572">        break;</a>
<a name="ln1573">    case QAppImageUpdateEnums::Error::QbufferIoReadError:</a>
<a name="ln1574">        ret += &quot;QbufferIoReadError&quot;;</a>
<a name="ln1575">        break;</a>
<a name="ln1576">    case QAppImageUpdateEnums::Error::SourceFileNotFound:</a>
<a name="ln1577">        ret += &quot;SourceFileNotFound&quot;;</a>
<a name="ln1578">        break;</a>
<a name="ln1579">    case QAppImageUpdateEnums::Error::NoPermissionToReadSourceFile:</a>
<a name="ln1580">        ret += &quot;NoPermissionToReadSourceFile&quot;;</a>
<a name="ln1581">        break;</a>
<a name="ln1582">    case QAppImageUpdateEnums::Error::CannotOpenSourceFile:</a>
<a name="ln1583">        ret += &quot;CannotOpenSourceFile&quot;;</a>
<a name="ln1584">        break;</a>
<a name="ln1585">    case QAppImageUpdateEnums::Error::NoPermissionToReadWriteTargetFile:</a>
<a name="ln1586">        ret += &quot;NoPermissionToReadWriteTargetFile&quot;;</a>
<a name="ln1587">        break;</a>
<a name="ln1588">    case QAppImageUpdateEnums::Error::CannotOpenTargetFile:</a>
<a name="ln1589">        ret += &quot;CannotOpenTargetFile&quot;;</a>
<a name="ln1590">        break;</a>
<a name="ln1591">    case QAppImageUpdateEnums::Error::TargetFileSha1HashMismatch:</a>
<a name="ln1592">        ret += &quot;TargetFileSha1HashMismatch&quot;;</a>
<a name="ln1593">        break;</a>
<a name="ln1594">    case QAppImageUpdateEnums::Error::TorrentNotSupported:</a>
<a name="ln1595">	ret += &quot;TorrentNotSupported&quot;;</a>
<a name="ln1596">	break;</a>
<a name="ln1597">    case QAppImageUpdateEnums::Error::TorrentSeedFailed:</a>
<a name="ln1598">	ret += &quot;TorrentSeedFailed&quot;;</a>
<a name="ln1599">	break;</a>
<a name="ln1600">    case QAppImageUpdateEnums::Error::OutdatedAppImageForSeed:</a>
<a name="ln1601">	ret += &quot;OutdatedAppImageForSeed&quot;;</a>
<a name="ln1602">	break;</a>
<a name="ln1603">    case QAppImageUpdateEnums::Error::IncompleteAppImageForSeed:</a>
<a name="ln1604">	ret += &quot;IncompleteAppImageForSeed&quot;;</a>
<a name="ln1605">	break;</a>
<a name="ln1606">    case QAppImageUpdateEnums::Error::UnsupportedActionForBuild:</a>
<a name="ln1607">        ret += &quot;UnsupportedActionForBuild&quot;;</a>
<a name="ln1608">        break;</a>
<a name="ln1609">    case QAppImageUpdateEnums::Error::InvalidAction:</a>
<a name="ln1610">        ret += &quot;InvalidAction&quot;;</a>
<a name="ln1611">        break;</a>
<a name="ln1612">    default:</a>
<a name="ln1613">        ret += &quot;Unknown&quot;;</a>
<a name="ln1614">        break;</a>
<a name="ln1615">    }</a>
<a name="ln1616">    return ret;</a>
<a name="ln1617">}</a>
<a name="ln1618"> </a>
<a name="ln1619">QString QAppImageUpdatePrivate::errorCodeToDescriptionString(short errorCode) {</a>
<a name="ln1620">    QString errorString;</a>
<a name="ln1621">    switch(errorCode) {</a>
<a name="ln1622">    case QAppImageUpdateEnums::Error::ConnectionRefusedError:</a>
<a name="ln1623">        errorString = QString::fromUtf8(&quot;The update server is not accepting requests.&quot;);</a>
<a name="ln1624">        break;</a>
<a name="ln1625">    case QAppImageUpdateEnums::Error::RemoteHostClosedError:</a>
<a name="ln1626">        errorString = QString::fromUtf8(&quot;The remote server closed the connection prematurely, &quot;);</a>
<a name="ln1627">        errorString += QString::fromUtf8(&quot;before the entire reply was received and processed.&quot;);</a>
<a name="ln1628">        break;</a>
<a name="ln1629">    case QAppImageUpdateEnums::Error::HostNotFoundError:</a>
<a name="ln1630">        errorString = QString::fromUtf8(&quot;The remote host name was not found (invalid hostname).&quot;);</a>
<a name="ln1631">        break;</a>
<a name="ln1632">    case QAppImageUpdateEnums::Error::TimeoutError:</a>
<a name="ln1633">        errorString = QString::fromUtf8(&quot;The connection to the remote server timed out.&quot;);</a>
<a name="ln1634">        break;</a>
<a name="ln1635">    case QAppImageUpdateEnums::Error::SslHandshakeFailedError:</a>
<a name="ln1636">        errorString = QString::fromUtf8(&quot;The SSL/TLS handshake failed and the encrypted channel &quot;);</a>
<a name="ln1637">        errorString += QString::fromUtf8(&quot;could not be established.&quot;);</a>
<a name="ln1638">        break;</a>
<a name="ln1639">    case QAppImageUpdateEnums::Error::TemporaryNetworkFailureError:</a>
<a name="ln1640">        errorString = QString::fromUtf8(&quot;The connection to the network was broken.&quot;);</a>
<a name="ln1641">        break;</a>
<a name="ln1642">    case QAppImageUpdateEnums::Error::NetworkSessionFailedError:</a>
<a name="ln1643">        errorString = QString::fromUtf8(&quot;The connection to the network was broken &quot;);</a>
<a name="ln1644">        errorString += QString::fromUtf8(&quot;or could not be initiated.&quot;);</a>
<a name="ln1645">        break;</a>
<a name="ln1646">    case QAppImageUpdateEnums::Error::BackgroundRequestNotAllowedError:</a>
<a name="ln1647">        errorString = QString::fromUtf8(&quot;The background request is not currently allowed due to platform policy.&quot;);</a>
<a name="ln1648">        break;</a>
<a name="ln1649">    case QAppImageUpdateEnums::Error::TooManyRedirectsError:</a>
<a name="ln1650">        errorString = QString::fromUtf8(&quot;While following redirects, the maximum limit was reached.&quot;);</a>
<a name="ln1651">        break;</a>
<a name="ln1652">    case QAppImageUpdateEnums::Error::InsecureRedirectError:</a>
<a name="ln1653">        errorString = QString::fromUtf8(&quot;While following redirects, there was a redirect &quot;);</a>
<a name="ln1654">        errorString += QString::fromUtf8(&quot;from a encrypted protocol (https) to an unencrypted one (http).&quot;);</a>
<a name="ln1655">        break;</a>
<a name="ln1656">    case QAppImageUpdateEnums::Error::ContentAccessDenied:</a>
<a name="ln1657">        errorString = QString::fromUtf8(&quot;The access to the remote content was denied (HTTP error 403).&quot;);</a>
<a name="ln1658">        break;</a>
<a name="ln1659">    case QAppImageUpdateEnums::Error::ContentOperationNotPermittedError:</a>
<a name="ln1660">        errorString = QString::fromUtf8(&quot;The operation requested on the remote content is not permitted.&quot;);</a>
<a name="ln1661">        break;</a>
<a name="ln1662">    case QAppImageUpdateEnums::Error::ContentNotFoundError:</a>
<a name="ln1663">        errorString = QString::fromUtf8(&quot;The remote content was not found at the server (HTTP error 404)&quot;);</a>
<a name="ln1664">        break;</a>
<a name="ln1665">    case QAppImageUpdateEnums::Error::AuthenticationRequiredError:</a>
<a name="ln1666">        errorString = QString::fromUtf8(&quot;The remote server requires authentication to serve the content, &quot;);</a>
<a name="ln1667">        errorString += QString::fromUtf8(&quot;but the credentials provided were not accepted or given.&quot;);</a>
<a name="ln1668">        break;</a>
<a name="ln1669">    case QAppImageUpdateEnums::Error::ContentConflictError:</a>
<a name="ln1670">        errorString = QString::fromUtf8(&quot;The request could not be completed due to a conflict with the &quot;);</a>
<a name="ln1671">        errorString += QString::fromUtf8(&quot;current state of the resource.&quot;);</a>
<a name="ln1672">        break;</a>
<a name="ln1673">    case QAppImageUpdateEnums::Error::ContentGoneError:</a>
<a name="ln1674">        errorString = QString::fromUtf8(&quot;The requested resource is no longer available at the server.&quot;);</a>
<a name="ln1675">        break;</a>
<a name="ln1676">    case QAppImageUpdateEnums::Error::InternalServerError:</a>
<a name="ln1677">        errorString = QString::fromUtf8(&quot;The server encountered an unexpected condition which prevented &quot;);</a>
<a name="ln1678">        errorString += QString::fromUtf8(&quot;it from fulfilling the request.&quot;);</a>
<a name="ln1679">        break;</a>
<a name="ln1680">    case QAppImageUpdateEnums::Error::OperationNotImplementedError:</a>
<a name="ln1681">        errorString = QString::fromUtf8(&quot;The server does not support the functionality required to fulfill the request.&quot;);</a>
<a name="ln1682">        break;</a>
<a name="ln1683">    case QAppImageUpdateEnums::Error::ServiceUnavailableError:</a>
<a name="ln1684">        errorString = QString::fromUtf8(&quot;The server is unable to handle the request at this time.&quot;);</a>
<a name="ln1685">        break;</a>
<a name="ln1686">    case QAppImageUpdateEnums::Error::ProtocolUnknownError:</a>
<a name="ln1687">        errorString = QString::fromUtf8(&quot;The Network Access API cannot honor the request because the protocol&quot;);</a>
<a name="ln1688">        errorString += QString::fromUtf8(&quot; is not known.&quot;);</a>
<a name="ln1689">        break;</a>
<a name="ln1690">    case QAppImageUpdateEnums::Error::ProtocolInvalidOperationError:</a>
<a name="ln1691">        errorString = QString::fromUtf8(&quot;The requested operation is invalid for this protocol.&quot;);</a>
<a name="ln1692">        break;</a>
<a name="ln1693">    case QAppImageUpdateEnums::Error::UnknownNetworkError:</a>
<a name="ln1694">        errorString = QString::fromUtf8(&quot;An unknown network-related error was detected.&quot;);</a>
<a name="ln1695">        break;</a>
<a name="ln1696">    case QAppImageUpdateEnums::Error::UnknownContentError:</a>
<a name="ln1697">        errorString = QString::fromUtf8(&quot;An unknown error related to the remote content was detected.&quot;);</a>
<a name="ln1698">        break;</a>
<a name="ln1699">    case QAppImageUpdateEnums::Error::ProtocolFailure:</a>
<a name="ln1700">        errorString = QString::fromUtf8(&quot;A breakdown in protocol was detected &quot;);</a>
<a name="ln1701">        errorString += QString::fromUtf8(&quot;(parsing error, invalid or unexpected responses, etc.)&quot;);</a>
<a name="ln1702">        break;</a>
<a name="ln1703">    case QAppImageUpdateEnums::Error::UnknownServerError:</a>
<a name="ln1704">        errorString = QString::fromUtf8(&quot;An unknown error related to the server response was detected.&quot;);</a>
<a name="ln1705">        break;</a>
<a name="ln1706">    case QAppImageUpdateEnums::Error::NoAppimagePathGiven:</a>
<a name="ln1707">        errorString = QString::fromUtf8(&quot;No AppImage given.&quot;);</a>
<a name="ln1708">        break;</a>
<a name="ln1709">    case QAppImageUpdateEnums::Error::AppimageNotReadable:</a>
<a name="ln1710">        errorString = QString::fromUtf8(&quot;The AppImage is not readable.&quot;);</a>
<a name="ln1711">        break;</a>
<a name="ln1712">    case QAppImageUpdateEnums::Error::NoReadPermission:</a>
<a name="ln1713">        errorString = QString::fromUtf8(&quot;You don't have the permission to read the AppImage.&quot;);</a>
<a name="ln1714">        break;</a>
<a name="ln1715">    case QAppImageUpdateEnums::Error::AppimageNotFound:</a>
<a name="ln1716">        errorString = QString::fromUtf8(&quot;The AppImage does not exist.&quot;);</a>
<a name="ln1717">        break;</a>
<a name="ln1718">    case QAppImageUpdateEnums::Error::CannotOpenAppimage:</a>
<a name="ln1719">        errorString = QString::fromUtf8(&quot;The AppImage cannot be opened.&quot;);</a>
<a name="ln1720">        break;</a>
<a name="ln1721">    case QAppImageUpdateEnums::Error::EmptyUpdateInformation:</a>
<a name="ln1722">        errorString = QString::fromUtf8(&quot;The AppImage does not include any update information.&quot;);</a>
<a name="ln1723">        break;</a>
<a name="ln1724">    case QAppImageUpdateEnums::Error::InvalidAppimageType:</a>
<a name="ln1725">        errorString = QString::fromUtf8(&quot;The AppImage has an unknown type.&quot;);</a>
<a name="ln1726">        break;</a>
<a name="ln1727">    case QAppImageUpdateEnums::Error::InvalidMagicBytes:</a>
<a name="ln1728">        errorString = QString::fromUtf8(&quot;The AppImage is not valid.&quot;);</a>
<a name="ln1729">        break;</a>
<a name="ln1730">    case QAppImageUpdateEnums::Error::InvalidUpdateInformation:</a>
<a name="ln1731">        errorString = QString::fromUtf8(&quot;The AppImage has invalid update information.&quot;);</a>
<a name="ln1732">        break;</a>
<a name="ln1733">    case QAppImageUpdateEnums::Error::NotEnoughMemory:</a>
<a name="ln1734">        errorString = QString::fromUtf8(&quot;Not enough memory.&quot;);</a>
<a name="ln1735">        break;</a>
<a name="ln1736">    case QAppImageUpdateEnums::Error::SectionHeaderNotFound:</a>
<a name="ln1737">        errorString = QString::fromUtf8(&quot;The AppImage does not contain update information &quot;);</a>
<a name="ln1738">        errorString += QString::fromUtf8(&quot;at a valid section header.&quot;);</a>
<a name="ln1739">        break;</a>
<a name="ln1740">    case QAppImageUpdateEnums::Error::UnsupportedElfFormat:</a>
<a name="ln1741">        errorString = QString::fromUtf8(&quot;The AppImage is not in supported ELF format.&quot;);</a>
<a name="ln1742">        break;</a>
<a name="ln1743">    case QAppImageUpdateEnums::Error::UnsupportedTransport:</a>
<a name="ln1744">        errorString = QString::fromUtf8(&quot;The AppImage specifies an unsupported update transport.&quot;);</a>
<a name="ln1745">        break;</a>
<a name="ln1746">    case QAppImageUpdateEnums::Error::IoReadError:</a>
<a name="ln1747">        errorString = QString::fromUtf8(&quot;Unknown IO read error.&quot;);</a>
<a name="ln1748">        break;</a>
<a name="ln1749">    case QAppImageUpdateEnums::Error::GithubApiRateLimitReached:</a>
<a name="ln1750">        errorString = QString::fromUtf8(&quot;GitHub API rate limit reached, please try again later.&quot;);</a>
<a name="ln1751">        break;</a>
<a name="ln1752">    case QAppImageUpdateEnums::Error::ErrorResponseCode:</a>
<a name="ln1753">        errorString = QString::fromUtf8(&quot;Bad response from the server, please try again later.&quot;);</a>
<a name="ln1754">        break;</a>
<a name="ln1755">    case QAppImageUpdateEnums::Error::NoMarkerFoundInControlFile:</a>
<a name="ln1756">    case QAppImageUpdateEnums::Error::InvalidZsyncHeadersNumber:</a>
<a name="ln1757">    case QAppImageUpdateEnums::Error::InvalidZsyncMakeVersion:</a>
<a name="ln1758">    case QAppImageUpdateEnums::Error::InvalidZsyncTargetFilename:</a>
<a name="ln1759">    case QAppImageUpdateEnums::Error::InvalidZsyncMtime:</a>
<a name="ln1760">    case QAppImageUpdateEnums::Error::InvalidZsyncBlocksize:</a>
<a name="ln1761">    case QAppImageUpdateEnums::Error::InvalidTargetFileLength:</a>
<a name="ln1762">    case QAppImageUpdateEnums::Error::InvalidHashLengthLine:</a>
<a name="ln1763">    case QAppImageUpdateEnums::Error::InvalidHashLengths:</a>
<a name="ln1764">    case QAppImageUpdateEnums::Error::InvalidTargetFileUrl:</a>
<a name="ln1765">    case QAppImageUpdateEnums::Error::InvalidTargetFileSha1:</a>
<a name="ln1766">    case QAppImageUpdateEnums::Error::HashTableNotAllocated:</a>
<a name="ln1767">    case QAppImageUpdateEnums::Error::InvalidTargetFileChecksumBlocks:</a>
<a name="ln1768">    case QAppImageUpdateEnums::Error::CannotOpenTargetFileChecksumBlocks:</a>
<a name="ln1769">    case QAppImageUpdateEnums::Error::CannotConstructHashTable:</a>
<a name="ln1770">    case QAppImageUpdateEnums::Error::QbufferIoReadError:</a>
<a name="ln1771">        errorString = QString::fromUtf8(&quot;Invalid zsync meta file.&quot;);</a>
<a name="ln1772">        break;</a>
<a name="ln1773">    case QAppImageUpdateEnums::Error::ZsyncControlFileNotFound:</a>
<a name="ln1774">        errorString = QString::fromUtf8(&quot;The zsync control file was not found in the specified location.&quot;);</a>
<a name="ln1775">        break;</a>
<a name="ln1776">    case QAppImageUpdateEnums::Error::SourceFileNotFound:</a>
<a name="ln1777">        errorString = QString::fromUtf8(&quot;The current AppImage could not be found, maybe it was deleted while updating?&quot;);</a>
<a name="ln1778">        break;</a>
<a name="ln1779">    case QAppImageUpdateEnums::Error::NoPermissionToReadSourceFile:</a>
<a name="ln1780">        errorString = QString::fromUtf8(&quot;You don't have the permission to read the current AppImage.&quot;);</a>
<a name="ln1781">        break;</a>
<a name="ln1782">    case QAppImageUpdateEnums::Error::CannotOpenSourceFile:</a>
<a name="ln1783">        errorString = QString::fromUtf8(&quot;The current AppImage cannot be opened.&quot;);</a>
<a name="ln1784">        break;</a>
<a name="ln1785">    case QAppImageUpdateEnums::Error::NoPermissionToReadWriteTargetFile:</a>
<a name="ln1786">        errorString = QString::fromUtf8(&quot;You have no write or read permissions for the new version.&quot;);</a>
<a name="ln1787">        break;</a>
<a name="ln1788">    case QAppImageUpdateEnums::Error::CannotOpenTargetFile:</a>
<a name="ln1789">        errorString = QString::fromUtf8(&quot;The new version cannot be opened to write or read.&quot;);</a>
<a name="ln1790">        break;</a>
<a name="ln1791">    case QAppImageUpdateEnums::Error::TargetFileSha1HashMismatch:</a>
<a name="ln1792">        errorString = QString::fromUtf8(&quot;The newly constructed AppImage failed the integrity check, please try again.&quot;);</a>
<a name="ln1793">        break;</a>
<a name="ln1794">    case QAppImageUpdateEnums::Error::TorrentNotSupported:</a>
<a name="ln1795">	errorString = QString::fromUtf8(&quot;The AppImage author does not support decentralized update.&quot;);</a>
<a name="ln1796">	break;</a>
<a name="ln1797">    case QAppImageUpdateEnums::Error::TorrentSeedFailed:</a>
<a name="ln1798">	errorString = QString::fromUtf8(&quot;The AppImage cannot be seeded.&quot;);</a>
<a name="ln1799">	break;</a>
<a name="ln1800">    case QAppImageUpdateEnums::Error::OutdatedAppImageForSeed:</a>
<a name="ln1801">	errorString = QString::fromUtf8(&quot;The AppImage is not the newest available for seeding.&quot;);</a>
<a name="ln1802">	break;</a>
<a name="ln1803">    case QAppImageUpdateEnums::Error::IncompleteAppImageForSeed:</a>
<a name="ln1804">	errorString = QString::fromUtf8(&quot;The AppImage is incomplete for seeding.&quot;);</a>
<a name="ln1805">	break;</a>
<a name="ln1806">    case QAppImageUpdateEnums::Error::UnsupportedActionForBuild:</a>
<a name="ln1807">        errorString = QString::fromUtf8(&quot;The current build of the core library does not support the requested action.&quot;);</a>
<a name="ln1808">        break;</a>
<a name="ln1809">    case QAppImageUpdateEnums::Error::InvalidAction:</a>
<a name="ln1810">        errorString = QString::fromUtf8(&quot;The requested action is invalid.&quot;);</a>
<a name="ln1811">        break;</a>
<a name="ln1812">    default:</a>
<a name="ln1813">        errorString = QString::fromUtf8(&quot;Unknown error.&quot;);</a>
<a name="ln1814">        break;</a>
<a name="ln1815">    }</a>
<a name="ln1816">    return errorString;</a>
<a name="ln1817">}</a>
<a name="ln1818"> </a>
<a name="ln1819">QString QAppImageUpdatePrivate::versionString() {</a>
<a name="ln1820">    return QString::fromUtf8(&quot;2.0.2&quot;);</a>
<a name="ln1821">}</a>

</code></pre>
<div class="balloon" rel="248"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1048/" target="_blank">V1048</a> The 'b_Running' variable was assigned the same value.</p></div>
<div class="balloon" rel="248"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1048/" target="_blank">V1048</a> The 'b_Started' variable was assigned the same value.</p></div>
<div class="balloon" rel="548"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1048/" target="_blank">V1048</a> The 'b_Canceled' variable was assigned the same value.</p></div>
<div class="balloon" rel="964"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v519/" target="_blank">V519</a> The 'b_Canceled' variable is assigned values twice successively. Perhaps this is a mistake. Check lines: 962, 964.</p></div>
<div class="balloon" rel="1087"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v519/" target="_blank">V519</a> The 'b_Canceled' variable is assigned values twice successively. Perhaps this is a mistake. Check lines: 1085, 1087.</p></div>
<div class="balloon" rel="1136"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v636/" target="_blank">V636</a> The 'bytesReceived / 1048576' expression was implicitly cast from 'long long' type to 'double' type. Consider utilizing an explicit type cast to avoid the loss of a fractional part. An example: double A = (double)(X) / Y;.</p></div>
<div class="balloon" rel="1137"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v636/" target="_blank">V636</a> The 'bytesTotal / 1048576' expression was implicitly cast from 'long long' type to 'double' type. Consider utilizing an explicit type cast to avoid the loss of a fractional part. An example: double A = (double)(X) / Y;.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
